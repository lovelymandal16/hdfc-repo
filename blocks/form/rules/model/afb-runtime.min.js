/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
* Copyright 2022 Adobe
* All Rights Reserved.
*
* NOTICE: All information contained herein is, and remains
* the property of Adobe and its suppliers, if any. The intellectual
* and technical concepts contained herein are proprietary to Adobe
* and its suppliers and are protected by all applicable intellectual
* property laws, including trade secret and copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe.

* Adobe permits you to use and modify this file solely in accordance with
* the terms of the Adobe license agreement accompanying it.
*************************************************************************/

/*
 *  Package: @aemforms/af-core
 *  Version: 0.22.158
 */
import{propertyChange as e,ExecuteRule as t,Initialize as n,RemoveItem as i,Change as s,FormLoad as r,FieldChanged as a,ValidationComplete as o,ScriptError as l,Valid as u,Invalid as d,SubmitSuccess as h,CustomEvent as c,RequestSuccess as p,RequestFailure as m,SubmitError as f,Submit as g,Save as _,Reset as y,SubmitFailure as v,Focus as M,RemoveInstance as b,AddInstance as j,AddItem as E,Click as x}from"./afb-events.min.js";import w from"../formula/index.min.js";import{format as T,parseDefaultDate as I,datetimeToNumber as $,parseDateSkeleton as D,numberToDatetime as N,formatDate as S,parseDate as O}from"./afb-formatters.min.js";function C(e,t,n,i){var s,r=arguments.length,a=r<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,n):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,n,i);else for(var o=e.length-1;o>=0;o--)(s=e[o])&&(a=(r<3?s(a):r>3?s(t,n,a):s(t,n))||a);return r>3&&a&&Object.defineProperty(t,n,a),a}const A=Object.freeze({PATTERN_MISMATCH:"patternMismatch",TOO_SHORT:"tooShort",TOO_LONG:"tooLong",RANGE_OVERFLOW:"rangeOverflow",RANGE_UNDERFLOW:"rangeUnderflow",TYPE_MISMATCH:"typeMismatch",VALUE_MISSING:"valueMissing",STEP_MISMATCH:"stepMismatch",FORMAT_MISMATCH:"formatMismatch",ACCEPT_MISMATCH:"acceptMismatch",FILE_SIZE_MISMATCH:"fileSizeMismatch",UNIQUE_ITEMS_MISMATCH:"uniqueItemsMismatch",MIN_ITEMS_MISMATCH:"minItemsMismatch",MAX_ITEMS_MISMATCH:"maxItemsMismatch",EXPRESSION_MISMATCH:"expressionMismatch",EXCLUSIVE_MAXIMUM_MISMATCH:"exclusiveMaximumMismatch",EXCLUSIVE_MINIMUM_MISMATCH:"exclusiveMinimumMismatch",ENUM_MISMATCH:"enumMismatch"}),F=Object.freeze({pattern:A.PATTERN_MISMATCH,minLength:A.TOO_SHORT,maxLength:A.TOO_LONG,maximum:A.RANGE_OVERFLOW,minimum:A.RANGE_UNDERFLOW,type:A.TYPE_MISMATCH,required:A.VALUE_MISSING,step:A.STEP_MISMATCH,format:A.FORMAT_MISMATCH,accept:A.ACCEPT_MISMATCH,maxFileSize:A.FILE_SIZE_MISMATCH,uniqueItems:A.UNIQUE_ITEMS_MISMATCH,minItems:A.MIN_ITEMS_MISMATCH,maxItems:A.MAX_ITEMS_MISMATCH,validationExpression:A.EXPRESSION_MISMATCH,exclusiveMinimum:A.EXCLUSIVE_MINIMUM_MISMATCH,exclusiveMaximum:A.EXCLUSIVE_MAXIMUM_MISMATCH,enum:A.ENUM_MISMATCH}),k=Object.freeze({[A.PATTERN_MISMATCH]:"Please match the format requested.",[A.TOO_SHORT]:"Please lengthen this text to ${0} characters or more.",[A.TOO_LONG]:"Please shorten this text to ${0} characters or less.",[A.RANGE_OVERFLOW]:"Value must be less than or equal to ${0}.",[A.RANGE_UNDERFLOW]:"Value must be greater than or equal to ${0}.",[A.TYPE_MISMATCH]:"Please enter a valid value.",[A.VALUE_MISSING]:"Please fill in this field.",[A.STEP_MISMATCH]:"Please enter a valid value.",[A.FORMAT_MISMATCH]:"Specify the value in allowed format : ${0}.",[A.ACCEPT_MISMATCH]:"The specified file type not supported.",[A.FILE_SIZE_MISMATCH]:"File too large. Reduce size and try again.",[A.UNIQUE_ITEMS_MISMATCH]:"All the items must be unique.",[A.MIN_ITEMS_MISMATCH]:"Specify a number of items equal to or greater than ${0}.",[A.MAX_ITEMS_MISMATCH]:"Specify a number of items equal to or less than ${0}.",[A.EXPRESSION_MISMATCH]:"Please enter a valid value.",[A.EXCLUSIVE_MINIMUM_MISMATCH]:"Value must be greater than ${0}.",[A.EXCLUSIVE_MAXIMUM_MISMATCH]:"Value must be less than ${0}.",[A.ENUM_MISMATCH]:"Please select a value from the allowed options."});let P={};var R,q,V;!function(e){e.CODE="code",e.UI="ui"}(R||(R={}));class L{fieldName;errorMessages;constructor(e="",t=[]){this.errorMessages=t,this.fieldName=e}}!function(e){e.NEXT_ITEM="nextItem",e.PREVIOUS_ITEM="previousItem"}(q||(q={})),function(e){e.INVISIBLE="invisible",e.VISIBLE="visible"}(V||(V={}));const U=e=>new Map(Object.entries(e)),z=U({date:"date-input","data-url":"file-input",binary:"file-input"}),H=U({number:"number-input",boolean:"checkbox",object:"panel",array:"panel",file:"file-input","file[]":"file-input"}),Q=["string[]","boolean[]","number[]","array"],B=e=>{const t=e.type||"string";if("enum"in e){return e.enum.length>2||Q.indexOf(t)>-1?"drop-down":"checkbox"}return"string"===t||"string[]"===t?z.get(e.format)||"text-input":H.get(t)||"text-input"},W=function(e){return"file"===e?.type||"file[]"===e?.type||("string"===e?.type||"string[]"===e?.type)&&("binary"===e?.format||"data-url"===e?.format)||"file-input"===e?.fieldType};function G(e,t){if(null===e||"object"!=typeof e)return e;let n;if(Array.isArray(e)){n=new Array(e.length);for(let i=0;i<e.length;i++)n[i]=G(e[i],t)}else{n={};for(const i of Object.keys(e))n[i]=G(e[i],t)}return t&&n&&n.id&&(n.id=t()),n}const X=e=>JSON.stringify(e,null,2),J=e=>e.repeatable&&(void 0===e.minOccur&&void 0===e.maxOccur||void 0!==e.minOccur&&void 0!==e.maxOccur&&0!==e.maxOccur||void 0!==e.minOccur&&void 0!==e.maxOccur&&0!==e.minOccur&&0!==e.maxOccur||void 0!==e.minOccur&&e.minOccur>=0||void 0!==e.maxOccur&&0!==e.maxOccur)||!1;class Z{constructor(e){this.host=e,this._definedProperties=new Set,this._propertiesWrapper={},this._initialized=!1}get properties(){return this._initialized||(this._setupInitialProperties(),this._initialized=!0),this._propertiesWrapper}set properties(t){const n=this.host._jsonModel.properties||{},i={...t};this.host._jsonModel.properties=i,Object.keys(i).forEach((e=>{this._ensurePropertyDescriptor(e)})),Object.keys({...n,...i}).forEach((t=>{if(n[t]!==i[t]){const s=e(`properties.${t}`,i[t],n[t]);this.host.notifyDependents(s)}}))}ensurePropertyDescriptor(e){this._ensurePropertyDescriptor(e)}_setupInitialProperties(){const e=this.host._jsonModel.properties||{};Object.keys(e).forEach((e=>{this._ensurePropertyDescriptor(e)})),this.host._jsonModel.properties||(this.host._jsonModel.properties={})}_ensurePropertyDescriptor(t){this._definedProperties.has(t)||(Object.defineProperty(this._propertiesWrapper,t,{get:()=>{t.startsWith("fd:")||this.host.ruleEngine.trackDependency(this.host,`properties.${t}`);return(this.host._jsonModel.properties||{})[t]},set:n=>{const i=this.host._jsonModel.properties||{},s=i[t];if(s!==n){const r={...i,[t]:n};this.host._jsonModel.properties=r;const a=e(`properties.${t}`,n,s);this.host.notifyDependents(a)}},enumerable:!0,configurable:!0}),this._definedProperties.add(t))}updateNestedProperty(t,n){const i=t.split("."),s=i[0];this._ensurePropertyDescriptor(s);const r=this.host._jsonModel.properties||{},a=JSON.parse(JSON.stringify(r)),o=a[s]||{};a[s]=o;let l=o;for(let e=1;e<i.length-1;e++)l[i[e]]?"object"!=typeof l[i[e]]&&(l[i[e]]={}):l[i[e]]={},l=l[i[e]];const u=i[i.length-1],d=l[u];l[u]=n,this.host._jsonModel.properties=a;const h=e(`properties.${t}`,n,d);this.host.notifyDependents(h)}updateSimpleProperty(e,t){this._ensurePropertyDescriptor(e),this._propertiesWrapper[e]=t}}class K{$_name;$_value;$_type;$_fields=[];parent;constructor(e,t,n=typeof t,i){this.$_name=e,this.$_value=t,this.$_type=n,this.parent=i}valueOf(){return this.$_value}get $name(){return this.$_name}get disabled(){return!this.$_fields.find((e=>!1!==e.enabled))&&this.$_fields.length}get $value(){const e=this.$_fields.find((e=>{if(W(e))return e}));if(e&&this.$_fields.every((e=>["string","string[]"].includes(e.type)))){const t=e.form._exportDataAttachmentMap;if(t&&t[e.id]){const n=t[e.id];return Array.isArray(n)?n.map((e=>e.data)):n.data}}return this.$_value}setValue(e,t,n){this.$_value=e,this.$_fields.forEach((e=>{n!==e&&(e.value=t)}))}get $type(){return this.$_type}$bindToField(e){-1===this.$_fields.indexOf(e)&&(this.$_fields.push(e),this._checkForTypeConflicts(e))}_checkForTypeConflicts(e){if(this.$_fields.length<=1)return;const t=e.type,n=this.$_fields.filter((n=>n&&n!==e&&n.type!==t));if(n.length>0){const i=n.map((e=>`Field "${e.id}" (${e.type})`)).join(", ");console.error(`Type conflict detected: Multiple fields with same dataRef have different types. New field '${e.id}' (${t}) conflicts with: ${i}. DataRef: ${this.$name}`)}}$convertToDataValue(){return this}get $isDataGroup(){return!1}$addDataNode(e,t,n=!1){throw"add Data Node is called on a data value"}}const Y=Symbol("NullValue");const ee=new class extends K{constructor(){super("",Y,"null")}setValue(){}$bindToField(){}$length(){return 0}$convertToDataValue(){return this}$addDataNode(){}$removeDataNode(){}$getDataNode(){return this}$containsDataNode(){return!1}};class te extends K{$_items;createEntry(e,t,n){const i=Array.isArray(t)?"array":typeof t;return"object"==typeof t&&null!=t?new te(e,t,i,n):new K(e,t,i,n)}constructor(e,t,n=typeof t,i){super(e,t,n,i),this.$_items=t instanceof Array?t.map(((e,t)=>this.createEntry(t,e,this))):Object.fromEntries(Object.entries(t).map((([e,t])=>[e,this.createEntry(e,t,this)])))}get $value(){return"array"===this.$type?Object.values(this.$_items).filter((e=>void 0!==e&&!e.disabled)).map((e=>e.$value)):Object.fromEntries(Object.values(this.$_items).filter((e=>void 0!==e&&!e.disabled)).map((e=>[e.$name,e.$value])))}get $length(){return Object.entries(this.$_items).length}$convertToDataValue(){return new K(this.$name,this.$value,this.$type,this.parent)}syncDataAndFormModel(e){this.$_fields.forEach((t=>{e&&e!==t&&t.syncDataAndFormModel(this)}))}$addDataNode(e,t,n=!1,i=null){if(t!==ee){if("array"===this.$type){const s=e;n?this.$_items[e]=t:this.$_items.splice(s,0,t),this.syncDataAndFormModel(i)}else this.$_items[e]=t;t.parent=this}}$removeDataNode(e,t=null){"array"===this.$type?(this.$_items.splice(e,1),this.syncDataAndFormModel(t)):this.$_items[e]=void 0}$getDataNode(e){if(this.$_items.hasOwnProperty(e))return this.$_items[e]}$containsDataNode(e){return this.$_items.hasOwnProperty(e)&&void 0!==this.$_items[e]}get $isDataGroup(){return!0}}const ne="Identifier",ie="Global",se="Repeatable",re="bracket",ae=(e,t)=>({type:ne,value:e,start:t}),oe=function(e){return e>="a"&&e<="z"||e>="A"&&e<="Z"||e>="0"&&e<="9"||"_"===e},le=(e,t,n)=>null===e&&"$"===t[n],ue=(e,t,n)=>null===e&&"#"===t[n],de=(e,t)=>{const n=e[t];return"$"===n?e.length>t&&oe(e[t+1]):n>="a"&&n<="z"||n>="A"&&n<="Z"||"_"===n},he=e=>e>="0"&&e<="9";class ce{stream;_current;_tokens=[];_result_tokens=[];constructor(e){this.stream=e,this._current=0}_consumeGlobal(){return this._current+=1,{type:ie,start:0,value:"$"}}_consumeRepeatable(){return this._current+=1,{type:se,start:0,value:"#"}}_consumeUnquotedIdentifier(e){const t=this._current;for(this._current+=1;this._current<e.length&&oe(e[this._current]);)this._current+=1;return ae(e.slice(t,this._current),t)}_consumeQuotedIdentifier(e){const t=this._current;this._current+=1;const n=e.length;for(;'"'!==e[this._current]&&this._current<n;){let t=this._current;"\\"!==e[t]||"\\"!==e[t+1]&&'"'!==e[t+1]?t+=1:t+=2,this._current=t}return this._current+=1,ae(JSON.parse(e.slice(t,this._current)),t)}_consumeNumber(e){const t=this._current;this._current+=1;const n=e.length;for(;he(e[this._current])&&this._current<n;)this._current+=1;const i=e.slice(t,this._current);return{type:"Number",value:parseInt(i,10),start:t}}_consumeBracket(e){const t=this._current;let n;if(this._current+=1,!he(e[this._current]))throw new Error(`unexpected exception at position ${this._current}. Must be a character`);if(n=this._consumeNumber(e).value,this._current<this.stream.length&&"]"!==e[this._current])throw new Error(`unexpected exception at position ${this._current}. Must be a character`);return this._current++,((e,t)=>({type:re,value:e,start:t}))(n,t)}tokenize(){const e=this.stream;for(;this._current<e.length;){const t=this._tokens.length?this._tokens.slice(-1)[0]:null;if(le(t,e,this._current)){const e=this._consumeGlobal();this._tokens.push(e),this._result_tokens.push(e)}else if(ue(t,e,this._current)){const e=this._consumeRepeatable();this._tokens.push(e),this._result_tokens.push(e)}else if(de(e,this._current)){const t=this._consumeUnquotedIdentifier(e);this._tokens.push(t),this._result_tokens.push(t)}else if("."===e[this._current]&&null!=t&&"DOT"!==t.type)this._tokens.push({type:"DOT",value:".",start:this._current}),this._current+=1;else if("["===e[this._current]){const t=this._consumeBracket(e);this._tokens.push(t),this._result_tokens.push(t)}else{if('"'!==e[this._current]){const e=Math.max(0,this._current-2),t=Math.min(this.stream.length,this._current+2);throw new Error(`Exception at parsing stream ${this.stream.slice(e,t)}`)}{const t=this._consumeQuotedIdentifier(e);this._tokens.push(t),this._result_tokens.push(t)}}}return this._result_tokens}}const pe=e=>new ce(e).tokenize(),me=(e,t,n)=>{let i;i="string"==typeof t?pe(t):t;let s=e,r=0;const a=(e,t,n)=>null===t?n:t.type===re?new te(e.value,[],"array"):new te(e.value,{});for(;r<i.length&&null!=s;){const t=i[r];if(t.type===ie)s=e;else if(t.type===ne){if(!(s instanceof te&&"object"===s.$type))throw new Error(`Looking for ${t.value} in ${s.$value}`);if(s.$containsDataNode(t.value)&&null!==s.$getDataNode(t.value).$value)s=s.$getDataNode(t.value);else if(n){const e=a(t,r<i.length-1?i[r+1]:null,n);s.$addDataNode(t.value,e),s=e}else s=void 0}else if(t.type===re){if(!(s instanceof te&&"array"===s.$type))throw new Error(`Looking for index ${t.value} in non array${s.$value}`);{const e=t.value;if(e<s.$length)s=s.$getDataNode(e);else if(n){const o=a(t,r<i.length-1?i[r+1]:null,n);s.$addDataNode(e,o),s=o}else s=void 0}}r+=1}return s};class fe{data;mediaType="application/octet-stream";name="unknown";size=0;constructor(e){Object.assign(this,e)}get type(){return this.mediaType}set type(e){this.mediaType=e}toJSON(){return{name:this.name,size:this.size,mediaType:this.mediaType,data:this.data.toString()}}equals(e){return this.data===e.data&&this.mediaType===e.mediaType&&this.name===e.name&&this.size===e.size}}const ge="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789_".split(""),_e=/^(\d*\.?\d+)(\\?(?=[KMGT])([KMGT])(?:i?B)?|B?)$/i,ye=e=>{const t=[];for(let n=0;n<=e;n++){let e;e=0===n?Math.floor(Math.random()*(ge.length-11)):Math.floor(Math.random()*ge.length),t.push(ge[e])}return t.join("")},ve=(e,t,n)=>{if(t&&null===e.dataRef)return n?Promise.resolve(null):null;let i=null;if(e.isContainer)return n?Me(e,t).then((e=>e)):be(e,t);if(W(e.getState())){i={};const t=e.name||"",s=null!=e.dataRef?e.dataRef:t.length>0?e.name:void 0;if(e.value instanceof Array)if("string[]"===e.type&&"data-url"===e?.format){if(n)return e.serialize().then((t=>(i[e.id]=t.map((e=>({...e,dataRef:s}))),i)));i[e.id]=e.value.map((e=>({...e,dataRef:s})))}else i[e.id]=e.value.map((e=>({...e,dataRef:s})));else if(null!=e.value)if("string"===e.type&&"data-url"===e?.format){if(n)return e.serialize().then((t=>(i[e.id]={...t[0],dataRef:s},i)));i[e.id]={...e.value,dataRef:s}}else i[e.id]={...e.value,dataRef:s}}return n?Promise.resolve(i):i},Me=async(e,t=!1)=>(e.items||[]).reduce((async(e,n)=>{const i=await e,s=await ve(n,t,!0);return Object.assign(i,s)}),Promise.resolve({})),be=(e,t=!1)=>(e.items||[]).reduce(((e,n)=>{const i=ve(n,t,!1);return Object.assign(e,i)}),{}),je=e=>{let t=0;if("string"==typeof e){const n=_e.exec(e.trim());null!=n&&(t=Ee(parseFloat(n[1]),(n[2]||"kb").toUpperCase()))}return t},Ee=(e,t)=>{const n=Math.pow(1024,{KB:1,MB:2,GB:3,TB:4}[t]);return Math.round(e*n)},xe=e=>null!=/^data:([a-z]+\/[a-z0-9-+.]+)?;(?:name=(.*);)?base64,(.*)$/.exec(e.trim()),we=e=>{const t=/^data:([a-z]+\/[a-z0-9-+.]+)?(?:;name=([^;]+))?(;base64)?,(.+)$/.exec(e);if(null!==t){const e=t[1]||"",n=t[2]||"unknown";if("string"==typeof t[3]){const i=atob(t[4]),s=[];for(let e=0;e<i.length;e++)s.push(i.charCodeAt(e));return{name:n,blob:new window.Blob([new Uint8Array(s)],{type:e})}}return{name:n,blob:new window.Blob([t[4]],{type:e})}}return null},Te=e=>{if(!e||!Object.keys(e).length)return e;if((":items"in(t=e)||"cqItems"in t)&&(":itemsOrder"in t||"cqItemsOrder"in t)){const t=[],n=e[":itemsOrder"]||e.cqItemsOrder,i=e[":items"]||e.cqItems;n.forEach((e=>{t.push(Te(i[e]))})),e.items=t}var t;return e},Ie=e=>{const t=/^[A-Za-z0-9_$][A-Za-z0-9_.[\]]*$/;if(e.includes(".")){return e.split(".").map((e=>{if(e.includes("[")){const n=e.indexOf("["),i=e.substring(0,n),s=e.substring(n);return t.test(i)?e:`"${i}"${s}`}return t.test(e)?e:`"${e}"`})).join(".")}return t.test(e)?e:`"${e}"`},$e=/^(\d{4})-(\d{1,2})-(\d{1,2})$/,De=/^[a-zA-Z0-9.!#$%&â€™*+/=?^_`{|}~-]+@[a-zA-Z0-9-]+(?:\.[a-zA-Z0-9-]+)*$/,Ne=[31,28,31,30,31,30,31,31,30,31,30,31],Se=e=>{if(""===e||null==e)return{value:"",valid:!0};let t=parseFloat(e);const n=!isNaN(t);return n||(t=e),{value:t,valid:n}},Oe=e=>{if(""===e||null==e)return{value:"",valid:!0};let t=parseFloat(e);const n=!isNaN(t)&&Math.round(t)===t;return n||(t=e),{value:t,valid:n}},Ce=e=>null==e||e instanceof Array?e:[e],Ae=e=>{const t="boolean"==typeof e||"true"===e||"false"===e;return{valid:t,value:"boolean"==typeof e?e:t?"true"===e:e}},Fe=e=>{const t=(e=>{if(null!==e){let t=null;if(e instanceof fe)t=e;else if("undefined"!=typeof File&&e instanceof File)t={name:e.name,mediaType:e.type,size:e.size,data:e};else if("string"==typeof e&&xe(e)){const n=we(e);if(null!==n){const{blob:e,name:i}=n;t={name:i,mediaType:e.type,size:e.size,data:e}}}else{let n=e;try{n=JSON.parse(e),t=n,t.mediaType||(t.mediaType=t.type)}catch(e){}if("string"==typeof n?.data&&xe(n?.data)){const e=we(n?.data);if(null!==e){const i=e.blob;t={name:n?.name,mediaType:n?.type||n?.mediaType,size:i.size,data:i}}}else"string"==typeof n?t={name:n.split("/").pop(),mediaType:"application/octet-stream",size:0,data:n}:"object"==typeof n&&(t={name:n?.name,mediaType:n?.type||n?.mediaType,size:n?.size,data:n?.data})}return null!==t&&null!=t.data?new fe(t):null}return null})(e),n=null!==t;return{value:n?t:e,valid:n}},ke=(e,t)=>{const n=Ce(e);return null==n?[[],[n]]:n.reduce(((e,n)=>{if(0==e[1].length){const i=t(n);e[i.valid?0:1].push(i.value)}return e}),[[],[]])},Pe={date:["minimum","maximum","exclusiveMinimum","exclusiveMaximum","format"],string:["minLength","maxLength","pattern"],number:["minimum","maximum","exclusiveMinimum","exclusiveMaximum"],array:["minItems","maxItems","uniqueItems"],file:["accept","maxFileSize"],email:["minLength","maxLength","format","pattern"],datetime:["minimum","maximum"]},Re=["type","format","minimum","maximum","exclusiveMinimum","exclusiveMaximum","minItems","maxItems","uniqueItems","minLength","maxLength","pattern","required","enum","accept","maxFileSize"],qe={type:(e,t)=>{let n=t;if(null==t)return{valid:!0,value:t};let i,s=!0;switch(e){case"string":s=!0,n=t.toString();break;case"string[]":n=Ce(t);break;case"number":i=Se(t),n=i.value,s=i.valid;break;case"boolean":i=Ae(t),s=i.valid,n=i.value;break;case"integer":i=Oe(t),s=i.valid,n=i.value;break;case"integer[]":i=ke(t,Oe),s=0===i[1].length,n=s?i[0]:t;break;case"file":i=Fe(t instanceof Array?t[0]:t),s=i.valid,n=i.value;break;case"file[]":i=ke(t,Fe),s=0===i[1].length,n=s?i[0]:t;break;case"number[]":i=ke(t,Se),s=0===i[1].length,n=s?i[0]:t;break;case"boolean[]":i=ke(t,Ae),s=0===i[1].length,n=s?i[0]:t}return{valid:s,value:n}},format:(e,t)=>{let n=!0;const i=t;if(null===t)return{value:i,valid:n};let s;switch(e){case"date":if(s=$e.exec((t||"").trim()),null!=s){const[e,t,i,r]=s,[a,o]=[+i,+r],l=(e=>e%400==0||e%4==0&&e%100!=0)(+t);n=a>=1&&a<=12&&o>=1&&o<=((e,t)=>e&&2==t?29:Ne[t-1])(l,a)}else n=!1;break;case"email":n=new RegExp(De).test((t||"").trim());break;case"data-url":n=!0}return{valid:n,value:i}},minimum:(e,t)=>({valid:t>=e,value:t}),maximum:(e,t)=>({valid:t<=e,value:t}),exclusiveMinimum:(e,t)=>({valid:t>e,value:t}),exclusiveMaximum:(e,t)=>({valid:t<e,value:t}),minItems:(e,t)=>({valid:t instanceof Array&&t.length>=e,value:t}),maxItems:(e,t)=>({valid:t instanceof Array&&t.length<=e,value:t}),uniqueItems:(e,t)=>({valid:!e||t instanceof Array&&t.length===new Set(t).size,value:t}),minLength:(e,t)=>({...qe.minimum(e,"string"==typeof t?t.length:0),value:t}),maxLength:(e,t)=>({...qe.maximum(e,"string"==typeof t?t.length:0),value:t}),pattern:(e,t)=>{let n;return n="string"==typeof e?new RegExp(e):e,{valid:n.test(t),value:t}},required:(e,t)=>({valid:!e||null!=t&&""!==t,value:t}),enum:(e,t)=>({valid:e.indexOf(t)>-1,value:t}),accept:(e,t)=>{if(!e||0===e.length||null==t)return{valid:!0,value:t};return{valid:!(t instanceof Array?t:[t]).some((t=>{return n=t.type,i=e,!(""!==n&&(!n||i.some((e=>{const t=e.trim(),i=t.split("/")[0],s=t.split(".")[1];return t.includes("*")&&n.startsWith(i)||t.includes(".")&&n.endsWith(s)||t===n}))));var n,i})),value:t}},maxFileSize:(e,t)=>{const n="string"==typeof e?je(e):e;return{valid:!(t instanceof fe)||t.size<=n,value:t}}},Ve=["value","label","description","visible","enabled","valid","errorMessage","readOnly","enum","enumNames","required","properties","exclusiveMinimum","exclusiveMaximum","maximum","maxItems","minimum","minItems","checked"],Le=[...Ve,"index","activeChild"],Ue=["plain-text","image"];class ze{_action;_target;_currentTarget;constructor(e,t){this._action=e,e.target?(this._currentTarget=t,this._target=e.target):(this._target=t,this._currentTarget=t)}get type(){return this._action.type}get payload(){return this._action.payload}get metadata(){return this._action.metadata}get target(){return this._target}get currentTarget(){return this._currentTarget}get isCustomEvent(){return this._action.isCustomEvent}get originalAction(){return this._action.originalAction}toString(){return this._action.toString()}}const He=Symbol("target"),Qe=Symbol("qualifiedName");const Be=e=>(...t)=>(n,i,s)=>{const r=s.get;null!=r&&(s.get=function(){if(t.indexOf(this.fieldType)>-1===e)return r.call(this)});const a=s.set;null!=a&&(s.set=function(n){this===this._ruleNode&&console.error(`Property '${i}' is being set through a proxy, which is not supported. Please use globals.functions.setProperty instead.`),t.indexOf(this.fieldType)>-1===e&&a.call(this,n)})},We=Be(!0),Ge=Be(!1);class Xe{_options;_ruleNode;_lang="";_callbacks={};_dependents=[];_jsonModel;_tokens=[];_eventSource=R.CODE;_fragment="$form";_idSet;_propertiesManager;createIdSet(){return new Set}get isContainer(){return!1}constructor(e,t){this._options=t,this._idSet=this.createIdSet(),this[Qe]=null,this._jsonModel={...e,id:this.form.getUniqueId(e?.id)},this.parent?.isFragment?this._fragment=this.parent.qualifiedName:this.parent?.fragment&&(this._fragment=this.parent.fragment),this._propertiesManager=new Z(this)}get fragment(){return this._fragment}setupRuleNode(){const e=this;this._ruleNode=new Proxy(this.ruleNodeReference(),{get:(t,n)=>e.getFromRule(t,n)})}ruleNodeReference(){return this}getRuleNode(){return this._ruleNode}getFromRule(e,t){if(t===Symbol.toPrimitive||"valueOf"===t&&!e.hasOwnProperty("valueOf"))return this.valueOf;if(t===He)return this;if("string"==typeof t)if(t.startsWith("$")){if("function"!=typeof this[t=t.substr(1)]){const e=this[t];return e instanceof Xe?e.getRuleNode():e instanceof Array?e.map((e=>e instanceof Xe?e.getRuleNode():e)):e}}else{if(e.hasOwnProperty(t))return e[t];if("function"==typeof e[t])return e[t]}}get id(){return this._jsonModel.id}get index(){return this.parent?this.parent.indexOf(this):0}get parent(){return this._options.parent}get type(){return this._jsonModel.type}get repeatable(){return this.parent?.hasDynamicItems()}get fieldType(){return this._jsonModel.fieldType||"text-input"}get":type"(){return this._jsonModel[":type"]||this.fieldType}get name(){return this._jsonModel.name}get screenReaderText(){return this._jsonModel.screenReaderText}get description(){return this._jsonModel.description}set description(e){this._setProperty("description",e)}get dataRef(){return this._jsonModel.dataRef}get visible(){return void 0!==this.parent?.visible?!!this.parent?.visible&&this._jsonModel.visible:this._jsonModel.visible}set visible(t){if(t!==this._jsonModel.visible){const n=e("visible",t,this._jsonModel.visible);this._jsonModel.visible=t,this.notifyDependents(n)}}get form(){return this._options.form}get ruleEngine(){return this.form.ruleEngine}get label(){return this._jsonModel.label}set label(t){if(!(null!==t&&null!==this._jsonModel.label&&"object"==typeof t&&"object"==typeof this._jsonModel.label?JSON.stringify(t)===JSON.stringify(this._jsonModel.label):t===this._jsonModel.label)){const n=e("label",t,this._jsonModel.label);this._jsonModel={...this._jsonModel,label:t},this.notifyDependents(n)}}get uniqueItems(){return this._jsonModel.uniqueItems}isTransparent(){const e="array"===this.parent?._jsonModel?.type;return!this._jsonModel.name&&!e}getDependents(){return this._dependents.map((e=>({id:e.node.id,propertyName:e.propertyName})))}getState(e=!1){return this.withDependencyTrackingControl(!0,(()=>({...this._jsonModel,properties:this.properties,index:this.index,parent:void 0,qualifiedName:this.qualifiedName,...!0===this.repeatable?{repeatable:!0,minOccur:this.parent.minItems,maxOccur:this.parent.maxItems}:{},":type":this[":type"],...e?{_dependents:this._dependents.length?this.getDependents():void 0,allowedComponents:void 0,columnClassNames:void 0,columnCount:void 0,gridClassNames:void 0}:{}})))}subscribe(e,t="change"){return this._callbacks[t]=this._callbacks[t]||[],this._callbacks[t].push(e),{unsubscribe:()=>{this._callbacks[t]=this._callbacks[t].filter((t=>t!==e))}}}_addDependent(e,n){if(void 0===this._dependents.find((({node:t,propertyName:i})=>{let s=t===e;return s&&n&&n.startsWith("properties.")&&(s=i===n),s}))){const i=this.subscribe((i=>{const s=i.payload.changes,r=[...Le,"items"];s.findIndex((e=>{const t=e.propertyName;return r.includes(t)||t.startsWith("properties.")&&n===t}))>-1&&("deps"===this.form.changeEventBehaviour?e.dispatch(i):e.dispatch(new t))}));this._dependents.push({node:e,propertyName:n,subscription:i})}}removeDependent(e){const t=this._dependents.findIndex((({node:t})=>t===e));t>-1&&(this._dependents[t].subscription.unsubscribe(),this._dependents.splice(t,1))}queueEvent(e){const t=new ze(e,this);this.form.getEventQueue().queue(this,t,["valid","invalid"].indexOf(t.type)>-1)}dispatch(e){this.queueEvent(e),this.form.getEventQueue().runPendingQueue()}withDependencyTrackingControl(e,t){const n=this.form?.ruleEngine.getDependencyTracking();e&&this.form?.ruleEngine.setDependencyTracking(!1);try{return t()}finally{e&&this.form?.ruleEngine.setDependencyTracking(n)}}notifyDependents(e){const t=this._jsonModel._dependents;t&&(t.forEach((e=>{const t=this.form.getElement(e.id);t&&this._addDependent(t,e.propertyName)})),this._jsonModel._dependents=void 0);(this._callbacks[e.type]||[]).forEach((t=>{this.withDependencyTrackingControl(!0,(()=>{t(new ze(e,this))}))}))}isEmpty(e=this._jsonModel.value){return null==e||""===e}_setProperty(t,n,i=!0,s=e=>{}){const r=this._jsonModel[t];let a=!1;if(a=null!==n&&null!==r&&"object"==typeof n&&"object"==typeof r?JSON.stringify(n)===JSON.stringify(r):r===n,!a){this._jsonModel[t]=n;const a=e(t,n,r);return i&&this.notifyDependents(a),s.call(this,a),Re.includes(t)&&(void 0===this.hasValueBeenSet||this.hasValueBeenSet)&&this.validate(),a.payload.changes}return[]}bindToDataModel(e){if("form"===this.fieldType||"$form"===this.id)return void(this._data=e);const t=this._jsonModel.dataRef;let n,i=e,s="";if(null===t)n=ee;else if(void 0===t||this.repeatable){if(e!==ee&&-1===Ue.indexOf(this.fieldType)){i=e;const t=this._jsonModel.name||"",r="array"===e.$type?this.index:t;if(s=r,""!==r){const i=this.defaultDataModel(r);void 0!==i&&("function"==typeof e.$getDataNode?(n=e.$getDataNode(r),void 0===n&&(n=i,e.$addDataNode(r,n))):(console.error(`$getDataNode method is undefined for "${t}" with dataModel type "${e.$type}"`),n=void 0))}else n=void 0}}else try{0===this._tokens.length&&(this._tokens=pe(t));let r=e;if(this._tokens[0].type===ie)r=this.form.getDataNode();else if(this._tokens[0].type===se){let e=this.parent;for(;!e.repeatable&&e!==this.form;)e=e.parent;r=e.getDataNode()}if(void 0!==r){const e=this._tokens[this._tokens.length-1].value,t=this.defaultDataModel(e);n=me(r,this._tokens,t),i=me(r,this._tokens.slice(0,-1)),s=e}}catch(e){console.error(`Error parsing dataRef "${t}" for field "${this.id}". The data of this field will not be exported.`)}return n&&(this.isContainer||i===ee||n===ee||(n=n?.$convertToDataValue(),i.$addDataNode(s,n,!0)),n?.$bindToField(this),this._data=n),this._data}_data;getDataNode(){return this._data}get lang(){return this._jsonModel.lang&&(this._lang=this._jsonModel.lang),this._lang||(this.parent?this._lang=this.parent.lang:this._lang=Intl.DateTimeFormat().resolvedOptions().locale),this._lang}get properties(){return this._propertiesManager.properties}set properties(e){this._propertiesManager.properties=e}getPropertiesManager(){return this._propertiesManager}getNonTransparentParent(){let e=this.parent;for(;null!=e&&e.isTransparent();)e=e.parent;return e}_isAncestorRepeatable(){let e=this.parent;for(;e&&!e.repeatable;)e=e.parent;return Boolean(e)}_initialize(e){if(void 0===this._data){let e,t=this.parent;do{e=t.getDataNode(),t=t.parent}while(void 0===e);this.bindToDataModel(e)}}_applyUpdates(e,t){return e.reduce(((e,n)=>{const i=t[n],s=this._setProperty(n,i,!1);return s.length>0&&(e[n]=s[0]),e}),{})}get qualifiedName(){if(this.isTransparent())return null;if(null!==this[Qe])return this[Qe];const e=this.getNonTransparentParent();let t;return t=e&&"array"===e.type?`${e.qualifiedName}[${this.index}]`:`${e.qualifiedName}.${this.name}`,this.repeatable||this._isAncestorRepeatable()||(this[Qe]=t),t}focus(){this.parent&&(this.parent.activeChild=this)}_getDefaults(){return{}}_applyDefaultsInModel(){Object.entries(this._getDefaults()).map((([e,t])=>{void 0===this._jsonModel[e]&&void 0!==t?this._jsonModel[e]=t:"object"!=typeof t||null===t||Array.isArray(t)||Object.keys(t).forEach((n=>{void 0===this._jsonModel[e][n]&&(this._jsonModel[e][n]=t[n])}))}))}}C([function(e,t,n){const i=n.get;null!=i&&(n.get=function(){return this.ruleEngine.trackDependency(this,t),i.call(this)})}],Xe.prototype,"index",null),C([function(e,t,n){const i=n.get;null!=i&&(n.get=function(){return this.ruleEngine.trackDependency(this,t),i.call(this)})}],Xe.prototype,"description",null),C([function(e,t,n){const i=n.get;null!=i&&(n.get=function(){return this.ruleEngine.trackDependency(this,t),i.call(this)})}],Xe.prototype,"visible",null),C([function(e,t,n){const i=n.get;null!=i&&(n.get=function(){return this.ruleEngine.trackDependency(this,t),i.call(this)})}],Xe.prototype,"label",null);class Je extends Xe{_events={};_rules={};getRules(){return"object"!=typeof this._jsonModel.rules?{}:this._jsonModel.rules}getCompiledRule(e,t){if(!(e in this._rules)){const n=t||this.getRules()[e];if(!("string"==typeof n&&n.length>0))throw new Error(`only expression strings are supported. ${typeof n} types are not supported`);{let t=n;try{if("$form"!==this.fragment){const e=Ie(this.fragment);t=n.replaceAll("$form",e)}this._rules[e]=this.ruleEngine.compileRule(t,this.lang)}catch(n){const i=`Unable to compile rule \`"${e}" : "${t}"\` Exception : ${n}`;this.form.logger.error(i);const s={name:this.name,error:i,event:e,rule:t,stack:n instanceof Error?n.stack:void 0};this.form.dispatch(new l(s,!1))}}}return this._rules[e]}getCompiledEvent(e){if(!(e in this._events)){let t=this._jsonModel.events?.[e];"string"==typeof t&&t.length>0&&(t=[t]),void 0!==t&&t.length>0&&(this._events[e]=t.map((t=>{let n=t;try{if("$form"!==this.fragment){const e=Ie(this.fragment);n=t.replaceAll("$form",e)}return this.ruleEngine.compileRule(n,this.lang)}catch(t){const i=`Unable to compile expression \`"${e}" : "${n}"\` Exception : ${t}`;this.form.logger.error(i);const s={name:this.name,error:i,event:e,rule:n,stack:t instanceof Error?t.stack:void 0};this.form.dispatch(new l(s,!1))}return null})).filter((e=>null!==e)))}return this._events[e]||[]}applyUpdates(e){"object"==typeof e?null!==e&&Object.entries(e).forEach((([e,t])=>{if(e in Ve||e in this&&"function"!=typeof this[e])try{this[e]=t}catch(e){console.error(e)}})):void 0!==e&&(this.value=e)}executeAllRules(e){const t=Object.entries(this.getRules());if(t.length>0){const n=this.getExpressionScope();t.forEach((([t,i])=>{const s=this.getCompiledRule(t,i);if(s){const r=this.ruleEngine.execute(s,n,e,!0,i);if(Ve.indexOf(t)>-1){this.isEmpty()&&this.isEmpty(r)&&"value"===t||(this[t]=r)}else this.form.logger.warn(`${t} is not a valid editable property.`)}}))}}getExpressionScope(){const e=this.getNonTransparentParent(),t={self:this.getRuleNode(),siblings:e?.ruleNodeReference()||{}},n=new Proxy(t,{get:(e,t)=>{if(t===Symbol.toStringTag)return"Object";if("string"==typeof t&&t.startsWith("$")){const n=e.self[t];return n instanceof Xe?n.getRuleNode():n instanceof Array?n.map((e=>e instanceof Xe?e.getRuleNode():e)):n}return t in e.siblings?e.siblings[t]:e.self[t]},has:(e,t)=>{const n=e.self[t],i=e.siblings[t];return void 0!==n||void 0!==i}});return n}executeEvent(e,t,n){let i;t&&(i=this.ruleEngine.execute(t,this.getExpressionScope(),e,!1,n),i instanceof Promise&&this.form.addPromises(i)),void 0!==i&&null!=i&&this.applyUpdates(i)}executeRule(e,t){void 0===e.payload.ruleName&&this.executeAllRules(t)}executeExpression(e){const t={form:this.form,$form:this.form.getRuleNode(),$field:this.getRuleNode(),field:this},n=this.ruleEngine.compileRule(e,this.lang);return this.ruleEngine.execute(n,this.getExpressionScope(),t,!1,e)}change(e,t){"deps"===this.form.changeEventBehaviour&&this.executeAllRules(t)}executeAction(e){const t={form:this.form,$form:this.form.getRuleNode(),$field:this.getRuleNode(),field:this,$event:{type:e.type,payload:e.payload,target:this.getRuleNode()}};this.ruleEngine.setDependencyTracking(["change","executeRule"].includes(e.type));const n=e.isCustomEvent?`custom:${e.type}`:e.type,i=e.isCustomEvent?`custom_${e.type}`:e.type,s=this.getCompiledEvent(n),r=this._jsonModel.events?.[n];i in this&&"function"==typeof this[i]&&this[i](e,t),s.forEach(((e,n)=>{let i="";Array.isArray(r)?i=r[n]:"string"==typeof r&&(i=r),this.executeEvent(t,e,i)})),e.target===this&&this.notifyDependents(e)}}const Ze=["readOnly","enabled"];class Ke extends Je{_children=[];_childrenReference;_itemTemplate=null;fieldFactory;_isFragment=!1;_insideFragment=!1;constructor(e,t){super(e,{form:t.form,parent:t.parent,mode:t.mode}),this._isFragment=!0===this._jsonModel?.properties?.["fd:fragment"],this.fieldFactory=t.fieldFactory}_getDefaults(){return{...super._getDefaults(),enabled:!0,readOnly:!1}}ruleNodeReference(){return this._childrenReference}get items(){return this._children}get maxItems(){return this._jsonModel.maxItems}set maxItems(t){this._jsonModel.maxItems=t;const n=this._jsonModel.minItems||1,i=this._children.length,s=Math.min(i-t,i-n);if(s>0){for(let e=0;e<s;e++)this.getDataNode().$removeDataNode(t+e),this._childrenReference.pop();const n=this._children.splice(t,s);this.notifyDependents(e("items",n,null))}}get minItems(){return this._jsonModel.minItems}set minItems(t){this._jsonModel.minItems=t;const n=this._children.length-t,i=Math.abs(n);if(n<0){const t=[];for(let e=0;e<i;e++)t.push(this._addChild(this._itemTemplate,null,!0));this.notifyDependents(e("items",t,null))}}hasDynamicItems(){return null!=this._itemTemplate}get isContainer(){return!0}_activeChild=null;isSiteContainer(e){return(":items"in e||"cqItems"in e)&&!("fieldType"in e)}isAFormField(e){return"fieldType"in e||"id"in e||"name"in e||"dataRef"in e||"type"in e}_getFormAndSitesState(e=!1,t=!1){return this._jsonModel.items?this._jsonModel.items.map((n=>{if(this.isSiteContainer(n)){const e={...n?.id?{id:this.form.getUniqueId()}:{}};return{...n,...e,":items":this.walkSiteContainerItems(n)}}return this.isAFormField(n)?{...this.form.getElement(n?.id).getState(e,t)}:n})):[]}getItemsState(e=!1,t=!1){return"array"===this._jsonModel.type||J(this._jsonModel)?this._children.map((e=>({...e.getState(!0,t)}))):this._getFormAndSitesState(e,t)}getState(e=!1,t=!1){return this.withDependencyTrackingControl(!0,(()=>({...super.getState(t),...t?{":items":void 0,":itemsOrder":void 0}:{},items:this.getItemsState(e,t),...("array"===this._jsonModel.type||J(this._jsonModel))&&this._itemTemplate?{_itemTemplate:{...this._itemTemplate}}:{},enabled:this.enabled,readOnly:this.readOnly})))}_createChild(e,t){return this.fieldFactory.createField(e,t)}walkSiteContainerItems(e){return Object.fromEntries(Object.entries(e[":items"]).map((([e,t])=>{if(this.isAFormField(t))return[e,this.form.getElement(t?.id).getState()];if(this.isSiteContainer(t))return this.walkSiteContainerItems(t);if("object"==typeof t){const n={...t?.id?{id:this.form.getUniqueId()}:{}};return[e,{...t,...n}]}return[e,t]})))}_addChildToRuleNode(e,t){const n=this,{parent:i=this}=t,s="array"==i.type?i._children.length+"":e.name||"";s.length>0&&Object.defineProperty(i._childrenReference,s,{get:()=>(e.isContainer&&e.hasDynamicItems()&&n.ruleEngine.trackDependency(e,"items"),n.hasDynamicItems()?(n.ruleEngine.trackDependency(n,"items"),void 0!==this._children[s]?this._children[s].getRuleNode():void 0):e.getRuleNode()),configurable:!0,enumerable:!0})}_addChild(e,t,n=!1,i="create"){let s=this;for(;null!=s&&s.isTransparent();)s=s.parent;("number"!=typeof t||t>s._children.length)&&(t=this._children.length);const r=this.form,a={index:t,...G(e,n?()=>r.getUniqueId():void 0)},o=this._createChild(a,{parent:this,form:this.form,mode:i});return e.id=o.id,this.form.fieldAdded(o),this._addChildToRuleNode(o,{parent:s}),t===this._children.length?this._children.push(o):this._children.splice(t,0,o),o}indexOf(e){return this._children.indexOf(e)}defaultDataModel(e){const t=this._jsonModel.type||void 0;if(void 0!==t){return new te(e,"array"===t?[]:{},t)}}_canHaveRepeatingChildren(e="create"){const t=this._jsonModel.items;return"array"==this._jsonModel.type&&null!=this.getDataNode()&&(1===t.length||t.length>0&&1==t[0].repeatable&&"restore"===e)}get isFragment(){return this._isFragment||this._jsonModel?.properties?.["fd:fragment"]}_initialize(e){super._initialize(e);const t=this._jsonModel.items||[];if(this._childrenReference="array"==this._jsonModel.type?[]:{},this._canHaveRepeatingChildren(e)){this._itemTemplate=this._jsonModel._itemTemplate||G(t[0]),this._jsonModel._itemTemplate=void 0,"restore"===e&&(this._itemTemplate.repeatable=void 0),"number"!=typeof this._jsonModel.minItems&&(this._jsonModel.minItems=0),"number"!=typeof this._jsonModel.maxItems&&(this._jsonModel.maxItems=-1),"number"!=typeof this._jsonModel.initialItems&&(this._jsonModel.initialItems=Math.max(1,this._jsonModel.minItems));const n="restore"===e?this._jsonModel.items.length:this._jsonModel.initialItems;for(let i=0;i<n;i++){let n;if("restore"===e){let s=this._itemTemplate;i<this._jsonModel.items.length&&(s=G(t[i]),s.repeatable=void 0),n=this._addChild(s,void 0,i>this._jsonModel.items.length-1,e)}else n=this._addChild(this._itemTemplate,void 0,i>this._jsonModel.items.length-1);"create"===e&&(t[0].id=n.id),n._initialize(e)}}else t.length>0?(t.forEach((t=>{if(this.isSiteContainer(t))this._initializeSiteContainer(t);else if(this.isAFormField(t)){this._addChild(t,void 0,!1,e)._initialize(e)}else this.form.logger.warn(`A container item was not initialized. ${t}`)})),this._jsonModel.minItems=this._children.length,this._jsonModel.maxItems=this._children.length,this._jsonModel.initialItems=this._children.length):this.form.logger.warn("A container exists with no items.");this.setupRuleNode()}_initializeSiteContainer(e){Object.entries(e[":items"]).forEach((([e,t])=>{if(this.isAFormField(t)){this._addChild(t)._initialize()}else if(this.isSiteContainer(t))return this._initializeSiteContainer(t)}))}addItem(i){if(("addItem"===i.type||"addInstance"==i.type)&&null!=this._itemTemplate&&(-1===this._jsonModel.maxItems||this._children.length<this._jsonModel.maxItems)){const s=this.getDataNode();let r=i.payload;const a=this._addChild(this._itemTemplate,i.payload,!0);("number"!=typeof r||r>this._children.length)&&(r=this._children.length);const o=a.defaultDataModel(r);o&&s.$addDataNode(r,o,!1,this),a._initialize("create"),this.notifyDependents(e("items",a.getState(),null)),a.dispatch(new n),a.dispatch(new t);for(let e=r+1;e<this._children.length;e++)this._children[e].dispatch(new t)}}removeItem(n){if(("removeItem"===n.type||"removeInstance"==n.type)&&null!=this._itemTemplate){if(0==this._children.length)return;let i=n.payload;"number"!=typeof i&&(i=this._children.length-1);const s=this._children[i].getState();if(this._children.length>this._jsonModel.minItems){this._childrenReference.pop(),this._children.splice(i,1),this.getDataNode().$removeDataNode(i,this);for(let e=i;e<this._children.length;e++)this._children[e].dispatch(new t);this.notifyDependents(e("items",null,s))}}}queueEvent(e){super.queueEvent(e),e.metadata?.dispatch&&this.items.forEach((t=>{t.queueEvent(e)}))}reset(){if(("array"===this.type||J(this._jsonModel))&&this.items.length>this._jsonModel.initialItems){const e=this.items.length-this._jsonModel.initialItems;for(let t=0;t<e;t++)this.dispatch(new i)}this.items.forEach((e=>{e.reset()}))}validate(){return this.items.flatMap((e=>e.validate())).filter((e=>""!==e.fieldName))}dispatch(e){super.dispatch(e)}importData(e){if(void 0!==this._data&&"array"===this.type&&Array.isArray(e)){const n=new te(this._data.$name,e,this._data.$type,this._data.parent);try{this._data.parent?.$addDataNode(n.$name,n,!0)}catch(e){return void this.form.logger.error(`unable to setItems for ${this.qualifiedName} : ${e}`)}this._data=n,this.syncDataAndFormModel(n);const i=this.items.length;for(let e=0;e<i;e+=1)this._children[e].dispatch(new t)}else void 0===this._data&&console.warn(`Data node is null, hence importData did not work for panel "${this.name}". Check if parent has a dataRef set to null.`)}syncDataAndFormModel(t){const i={added:[],removed:[]};if("array"===t?.$type&&null!=this._itemTemplate){const s=t?.$value.length,r=this._children.length,a=-1===this._jsonModel.maxItems?s:this._jsonModel.maxItems,o=this._jsonModel.minItems;let l=Math.min(s-r,a-r);const u=Math.min(r-s,r-o);for(;l>0;){l--;const e=this._addChild(this._itemTemplate,this.items.length,!0);e._initialize("create"),i.added.push(e)}if(u>0)for(let e=0;e<u;e++)this._childrenReference.pop(),i.removed.push(this._children.pop());i.added.forEach((t=>{this.notifyDependents(e("items",t.getState(),null)),t.dispatch(new n)})),i.removed.forEach((t=>{this.notifyDependents(e("items",null,t.getState()))}))}return this._children.forEach((e=>{let n=e.bindToDataModel(t);e.isContainer&&!n&&(n=t),e.syncDataAndFormModel(n)})),i}get activeChild(){return this._activeChild}set activeChild(t){if(t!==this._activeChild){let n=this._activeChild;for(;n instanceof Ke;){const e=n.activeChild;n.activeChild=null,n=e}const i=e("activeChild",t?.getState(),this._activeChild?.getState());this._activeChild=t,this.parent&&null!==t&&(this.parent.activeChild=this),this._jsonModel.activeChild=t?.id,this.notifyDependents(i)}}get enabled(){const e=this.parent?.enabled;return void 0!==e?!!e&&this._jsonModel.enabled:this._jsonModel.enabled}set enabled(e){this._setProperty("enabled",e,!0,this.notifyChildren)}get readOnly(){return void 0!==this.parent?.readOnly&&!!this.parent.readOnly||this._jsonModel.readOnly}set readOnly(e){this._setProperty("readOnly",e,!0,this.notifyChildren)}notifyChildren(t){if(void 0!==t.payload&&void 0!==t.payload.changes)for(const n of t.payload.changes)void 0!==n.propertyName&&Ze.includes(n.propertyName)&&this.items.forEach((i=>{n.currentValue!==i._jsonModel[n.propertyName]&&(i._jsonModel[n.propertyName]=n.currentValue,this.notifyDependents.call(i,e(n.propertyName,i.getState()[n.propertyName],null))),"panel"===i.fieldType&&this.notifyChildren.call(i,t)}))}}C([function(e,t,n){const i=n.get;null!=i&&(n.get=function(){return this.ruleEngine.trackDependency(this,t),i.call(this)})}],Ke.prototype,"maxItems",null),C([function(e,t,n){const i=n.get;null!=i&&(n.get=function(){return this.ruleEngine.trackDependency(this,t),i.call(this)})}],Ke.prototype,"minItems",null),C([function(e,t,n){const i=n.get;null!=i&&(n.get=function(){return this.ruleEngine.trackDependency(this,t),i.call(this)})}],Ke.prototype,"activeChild",null);class Ye{_jsonModel;constructor(e){this._jsonModel={...e}}getP(e,t){return((e,t,n)=>{if(t in e)return e[t];if(!t.startsWith(":")){const n=`:${t}`;if(n in e)return e[n]}return n})(this._jsonModel,e,t)}get isContainer(){return!1}}class et extends Ye{get version(){return this.getP("version","")}get grammar(){return this.getP("grammar","")}}class tt{lang;captchaInfo;constructor(e={}){this.lang=e.lang||"en",this.captchaInfo=e.captchaInfo||{},Object.keys(e).forEach((t=>{"lang"!==t&&"captchaInfo"!==t&&(this[t]=e[t])}))}}const nt={off:0,debug:1,info:2,warn:3,error:4};class it{debug(e){this.log(e,"debug")}info(e){this.log(e,"info")}warn(e){this.log(e,"warn")}error(e){this.log(e,"error")}log(e,t){0!==this.logLevel&&this.logLevel<=nt[t]&&console[t](e)}isLevelEnabled(e){return 0!==this.logLevel&&this.logLevel<=nt[e]}logLevel;constructor(e="off"){this.logLevel=nt[e]}}class st{_node;_event;constructor(e,t){this._node=e,this._event=t}get node(){return this._node}get event(){return this._event}isEqual(e){return null!=e&&this._node==e._node&&this._event.type==e._event.type}toString(){return this._node.id+"__"+this.event.type}valueOf(){return this.toString()}}class rt{logger;static MAX_EVENT_CYCLE_COUNT=10;_runningEventCount;_isProcessing=!1;_pendingEvents=[];constructor(e=new it("off")){this.logger=e,this._runningEventCount={}}get length(){return this._pendingEvents.length}get isProcessing(){return this._isProcessing}isQueued(e,t){const n=new st(e,t);return void 0!==this._pendingEvents.find((e=>n.isEqual(e)))}queue(e,t,n=!1){e&&t&&(t instanceof Array||(t=[t]),t.forEach((t=>{const i=new st(e,t),s=this._runningEventCount[i.valueOf()]||0;if(s<rt.MAX_EVENT_CYCLE_COUNT){let r="";if("change"!==t?.type||t?.payload?.changes.map((e=>e.propertyName)).includes("activeChild")?t?.type.includes("setProperty")&&(r=JSON.stringify(t.payload,null,2)):r=JSON.stringify(t.payload.changes,null,2),this.logger.isLevelEnabled("info")&&e.withDependencyTrackingControl(!0,(()=>{this.logger.info(`Queued event : ${t.type} node: ${e.id} - ${e.qualifiedName} - ${r}`)})),n){const e=this._isProcessing?1:0;this._pendingEvents.splice(e,0,i)}else this._pendingEvents.push(i);this._runningEventCount[i.valueOf()]=s+1}else this.logger.info(`Skipped queueing event : ${t.type} node: ${e.id} - ${e.name} with count=${s}`)})))}empty(){this._pendingEvents=[]}runPendingQueue(){if(!this._isProcessing){for(this._isProcessing=!0;this._pendingEvents.length>0;){const e=this._pendingEvents[0];this.logger.info(`Dequeued event : ${e.event.type} node: ${e.node.id} - ${e.node.name}`),e.node.executeAction(e.event),this._pendingEvents.shift()}this._runningEventCount={},this._isProcessing=!1}}}const at=(e,t=null,n={})=>{const i={...ot,...n},s="GET"===i.method&&t?lt(e,t):e;return"GET"!==i.method&&(i.body=t),fetch(s,{...i}).then((async t=>{let n;t.ok||console.error(`Error while fetching response from ${e} : ${t.statusText}`),n=t?.headers?.get("Content-Type")?.includes("application/json")?await t.json():await t.text();const i={};return t?.headers?.forEach(((e,t)=>{i[t]=e})),{status:t.status,body:n,headers:i}})).catch((t=>{throw console.error(`Network error while fetching from ${e}:`,t),t}))},ot={method:"GET"},lt=(e,t)=>{if(!t)return e;let n={};try{n=JSON.parse(t)}catch(e){console.log("Query params invalid")}const i=[];return Object.keys(n).forEach((e=>{Array.isArray(n[e])?i.push(`${encodeURIComponent(e)}=${encodeURIComponent(JSON.stringify(n[e]))}`):i.push(`${encodeURIComponent(e)}=${encodeURIComponent(n[e])}`)})),i.length?e.includes("?")?`${e}&${i.join("&")}`:`${e}?${i.join("&")}`:e};const ut=e=>{const t=e;return t.length>0&&t.startsWith("custom:")?t.substring(7):t},dt=async(e,t,n,i,s,r,a)=>{const o=t,l={method:n};let u,d={},g=null;try{i instanceof Promise&&(i=await i)}catch(r){throw console.error("Error resolving payload Promise:",r),r}if(i.body&&i.headers&&(d={...i},a={...i.headers},g=(i=i.body).cryptoMetadata,u=i),i&&i instanceof fe&&i.data instanceof File){const e=new FormData;e.append(i.name,i.data),u=e}else if(i instanceof FormData)u=i;else if(i&&("string"==typeof i||"object"==typeof i&&Object.keys(i).length>0)){const e=Object.keys(a);e.length>0?l.headers={...a,...-1===e.indexOf("Content-Type")?{"Content-Type":"application/json"}:{}}:l.headers={"Content-Type":"application/json"};const t=l?.headers?.["Content-Type"]||"application/json";"object"==typeof i&&("application/json"===t?u=JSON.stringify(i):t.indexOf("multipart/form-data")>-1?u=ct(i):t.indexOf("application/x-www-form-urlencoded")>-1&&(u=ht(i))),"text/plain"===t&&(u=String(i))}const _=(t,n,i)=>{const s=ut(n);"submitError"===n?(e.form.dispatch(new f(t,!0)),e.form.dispatch(new v(t,!0))):e.field?e.field.dispatch(new c(s,t,!0)):e.form.dispatch(new c(s,t,!0)),e.form.dispatch(new m(i,!1))},y=e.$field||null,M={request:{url:o,method:n,...d},targetField:y,targetEvent:e.$event||null};try{const t=await at(o,u,l);t.originalRequest={url:o,method:n,...g&&{cryptoMetadata:g},...d},t.submitter=y;const i={...M,response:t,request:t.originalRequest};if(t?.status>=200&&t?.status<=299){const n=ut(s);"submitSuccess"===s?e.form.dispatch(new h(t,!0)):e.field?e.field.dispatch(new c(n,t,!0)):e.form.dispatch(new c(n,t,!0)),e.form.dispatch(new p(i,!1))}else e.form.logger.error("Error invoking a rest API"),_(t,r,i);return t}catch(t){e.form.logger.error("Network error while invoking a rest API:",t);const n={body:null,headers:{},error:t instanceof Error?t.message:String(t)},i={...M,response:n};_(n,r,i),e.form.dispatch(new m(i,!1))}},ht=e=>{const t=new URLSearchParams;return Object.entries(e).forEach((([e,n])=>{null!=n&&"object"==typeof n?t.append(e,X(n)):t.append(e,n)})),t},ct=(e,t)=>{const n=new FormData;Object.entries(e).forEach((([e,t])=>{null!=t&&"object"==typeof t?n.append(e,X(t)):n.append(e,t)}));const i=(e,t)=>{if(e?.data instanceof File){let n=`${e?.dataRef}/${e?.name}`;n.startsWith("/")||(n=`/${n}`),t.append(n,e.data)}};return t&&Object.keys(t).reduce(((e,s)=>{const r=t[s];return r&&r instanceof Array?[...e,...r.map((e=>i(e,n)))]:[...e,i(r,n)]}),[]),n},pt=(e,t={},r=!1)=>{switch(e){case"change":return new s(t);case"submit":return new g(t);case"save":return new _(t);case"click":return new x(t);case"addItem":return new E(t);case"removeItem":return new i(t);case"reset":return new y(t);case"addInstance":return new j(t);case"removeInstance":return new b(t);case"invalid":return new d(t);case"valid":return new u(t);case"initialize":return new n(t);case"focus":return new M(t);default:console.error("invalid action")}};class mt{static instance=null;customFunctions={};constructor(){}static getInstance(){return mt.instance||(mt.instance=new mt),mt.instance}registerFunctions(e){Object.entries(e).forEach((([e,t])=>{let n=t;"function"==typeof t&&(n={_func:(e,n,i)=>{const s={form:i.globals.$form,field:i.globals.$field,event:i.globals.$event,functions:{setProperty:(e,t)=>{const s=[e,"custom:setProperty",t];return mt.getInstance().getFunctions().dispatchEvent._func.call(void 0,s,n,i)},reset:e=>{const t=[e=e||"reset","reset"];return i.globals.form.logger.warn("This usage of reset is deprecated. Please see the documentation and update."),mt.getInstance().getFunctions().dispatchEvent._func.call(void 0,t,n,i)},validate:e=>{const t=[e];return mt.getInstance().getFunctions().validate._func.call(void 0,t,n,i)},importData:(e,t)=>{const s=[e,t];return mt.getInstance().getFunctions().importData._func.call(void 0,s,n,i)},exportData:()=>mt.getInstance().getFunctions().exportData._func.call(void 0,e,n,i),submitForm:(e,t,s)=>{const r=[e,t,s||"multipart/form-data"];return mt.getInstance().getFunctions().submitForm._func.call(void 0,r,n,i)},markFieldAsInvalid:(e,t,n)=>{!n||n.useId?i.globals.form.getElement(e)?.markAsInvalid(t):n&&n.useDataRef?i.globals.form.visit((function(n){n.dataRef===e&&n.markAsInvalid(t)})):n&&n.useQualifiedName&&i.globals.form.resolveQualifiedName(e)?.markAsInvalid(t)},setFocus:(e,t)=>{const s=[e,t];return mt.getInstance().getFunctions().setFocus._func.call(void 0,s,n,i)},dispatchEvent:(e,t,s,r)=>{const a=[e,t,s,r];return mt.getInstance().getFunctions().dispatchEvent._func.call(void 0,a,n,i)},getFiles:e=>{const t={};e||i.globals.form.visit((function(e){"file-input"===e.fieldType&&e.value&&(t[e.qualifiedName]=e.serialize())}));const n=i.globals.form.resolveQualifiedName(e);return"file-input"===n?.fieldType&&n?.value&&(t[e]=n.serialize()),t}}};return t(...e,s)},_signature:[]}),n.hasOwnProperty("_func")?mt.getInstance().customFunctions[e]=n:console.warn(`Unable to register function with name ${e}.`)}))}unregisterFunctions(...e){e.forEach((e=>{e in mt.getInstance().customFunctions&&delete mt?.getInstance().customFunctions[e]}))}getFunctions(){function e(t){return null==t?t:null!==(n=t)&&"[object Array]"===Object.prototype.toString.call(n)?t.map((t=>e(t))):t.valueOf();var n}function t(e){return null==e?"":e.toString()}const n={validate:{_func:(e,t,n)=>{const i=e[0];let s;return s="string"==typeof i||void 0===i?n.globals.form.validate():n.globals.form.getElement(i.$id).validate(),Array.isArray(s)&&s.length&&n.globals.form.logger.warn("Form Validation Error"),s},_signature:[]},setFocus:{_func:(e,t,n)=>{const i=e[0],s=e[1];try{const e=n.globals.form.getElement(i?.$id)||n.globals.field;n.globals.form.setFocus(e,s)}catch(e){n.globals.form.logger.error("An error has occurred within the setFocus API.")}},_signature:[]},getData:{_func:(e,t,n)=>(n.globals.form.logger.warn("The `getData` function is depricated. Use `exportData` instead."),n.globals.form.withDependencyTrackingControl(!0,(()=>n.globals.form.exportData()))),_signature:[]},exportData:{_func:(e,t,n)=>n.globals.form.withDependencyTrackingControl(!0,(()=>n.globals.form.exportData())),_signature:[]},importData:{_func:(e,t,n)=>n.globals.form.withDependencyTrackingControl(!0,(()=>{const t=e[0],i=e[1];if("object"!=typeof t||null===t||i){const e=n.globals.form.resolveQualifiedName(i);e?.isContainer?e.importData(t,i):n.globals.form.logger.error("Invalid argument passed in importData. A container is expected")}else n.globals.form.importData(t);return{}})),_signature:[]},submitForm:{_func:async(n,i,s)=>{let r,a,o,l=null,u=null;n.length>0&&"object"==typeof e(n[0])?(r=n.length>0?e(n[0]):null,a=!(n.length>1)||e(n[1]),o=n.length>2?t(n[2]):"multipart/form-data"):(s.globals.form.logger.warn("This usage of submitForm is deprecated. Please see the documentation and update"),l=t(n[0]),u=t(n[1]),o=n.length>2?t(n[2]):"multipart/form-data",r=n.length>3?e(n[3]):null,a=!(n.length>4)||e(n[4]));const d=s.globals.form;if(d.captcha&&(d.captcha.captchaDisplayMode===V.INVISIBLE||"enterprise"===d.captcha.properties["fd:captcha"]?.config?.version&&"score"===d.captcha.properties["fd:captcha"]?.config?.keyType)){if("function"!=typeof s.runtime.functionTable.fetchCaptchaToken?._func)return s.globals.form.logger.error("fetchCaptchaToken is not defined"),s.globals.form.dispatch(new f({type:"FetchCaptchaTokenNotDefined"})),{};try{const e=await s.runtime.functionTable.fetchCaptchaToken._func([],i,s);d.captcha.value=e}catch(e){return s.globals.form.logger.error("Error while fetching captcha token"),s.globals.form.dispatch(new f({type:"FetchCaptchaTokenFailed"})),{}}}return s.globals.form.dispatch(new g({success:l,error:u,submit_as:o,validate_form:a,data:r})),{}},_signature:[]},saveForm:{_func:(e,n,i)=>{const s=t(e[0]),r=e[2]||!1;return i.globals.form.dispatch(new _({action:s,validate_form:r})),{}},_signature:[]},setVariable:{_func:(e,n,i)=>{const s=t(e[0]);let r=e[1];const a=e[2]||i.globals.form;if(r&&"object"==typeof r&&r.$qualifiedName){r=i.globals.form.getElement(r.$id)._jsonModel.value}return(a.$id?i.globals.form.getElement(a.$id):i.globals.form).getPropertiesManager().updateSimpleProperty(s,r),{}},_signature:[]},getVariable:{_func:(e,n,i)=>{const s=t(e[0]),r=e[1]||i.globals.form;if(!s)return;const a=(r.$id?i.globals.form.getElement(r.$id):i.globals.form).getPropertiesManager();if(s.includes(".")){const e=s.replace(/\[/g,".").replace(/\]/g,"").split(".").filter(Boolean);let t=a.properties;for(const n of e){if(null==t)return;t=t[n]}return t}return a.ensurePropertyDescriptor(s),a.properties[s]},_signature:[]},request:{_func:(n,i,s)=>{const r=t(n[0]),a=t(n[1]);let o,l,u,d={};if(n[2]&&"object"==typeof n[2]&&!n[2].then&&("data"in n[2]||"headers"in n[2])){const t=e(n[2]);o=t.data,d=t.headers||{},l=e(n[3]),u=e(n[4])}else o=e(n[2]),"string"==typeof n[3]?(s.globals.form.logger.warn("This usage of request is deprecated. Please see the documentation and update"),l=e(n[3]),u=e(n[4])):(d=e(n[3]),l=e(n[4]),u=e(n[5]));return dt(s.globals,r,a,o,l,u,d)},_signature:[]},requestWithRetry:{_func:(n,i,s)=>{const r=t(n[0]),a=t(n[1]);let o,l,u=e(n[2]);return"string"==typeof n[3]&&5===n.length?(o=e(n[3]),l=e(n[4])):"string"==typeof n[4]&&6===n.length&&(o=e(n[4]),l=e(n[5])),async e=>{try{u instanceof Promise&&(u=await u)}catch(e){throw console.error("Error resolving payload Promise:",e),e}let t={},i={},d=null;5===n.length?(i=u.body||{},t=u.headers||{},d=u.cryptoMetadata):(i=u||{},t=n[3]||{}),e&&(e.body&&(i={...i,...e.body}),e.headers&&(t={...t,...e.headers}));const h={body:i,headers:t,...d&&{cryptoMetadata:d}};try{return await dt(s.globals,r,a,h,o,l,t)}catch(e){if(e&&"object"==typeof e&&"status"in e&&e.status>=400)throw e;throw new Error("Request failed")}}},_signature:[]},retryHandler:{_func:(t,n,i)=>e(t[0])(),_signature:[]},awaitFn:{_func:async(e,t,i)=>{const s=e[1],r=i.globals.$field;try{const a=await e[0];n.dispatchEvent._func([r,s,a],t,i)}catch(s){const a=e[2];a&&n.dispatchEvent._func([r,a,s],t,i)}return{}},_signature:[]},addInstance:{_func:(t,n,i)=>{const s=t[0],r=t.length>1?e(t[1]):void 0;try{const e=i.globals.form.getElement(s.$id),t=pt("addInstance",r);e.addItem(t)}catch(e){i.globals.form.logger.error("Invalid argument passed in addInstance. An element is expected")}},_signature:[]},removeInstance:{_func:(t,n,i)=>{const s=t[0],r=t.length>1?e(t[1]):void 0;try{const e=i.globals.form.getElement(s.$id),t=pt("removeInstance",r);e.removeItem(t)}catch(e){i.globals.form.logger.error("Invalid argument passed in removeInstance. An element is expected")}},_signature:[]},dispatchEvent:{_func:(t,n,i)=>{const s=t[0];if(null===s&&"string"!=typeof i)return i.debug.push("Invalid argument passed in dispatchEvent. An element is expected"),{};let r,a=e(t[1]),o=t.length>2?e(t[2]):void 0,l=t.length>3&&e(t[3]);if("string"==typeof s&&(o=a,a=s,l=!0),r=a.startsWith("custom:")?new c(a.substring(7),o,l):pt(a,o,l),null!=r)if("string"==typeof s)i.globals.form.dispatch(r);else{const e=(e,t,n)=>{n.globals.form.getElement(e.$id).dispatch(t)};Array.isArray(s)&&s.length>0&&void 0===s.$id?s.forEach((t=>{e(t,r,i)})):e(s,r,i)}return{}},_signature:[]},encrypt:{_func:async(t,n,i)=>e(t[0]),_signature:[]},decrypt:{_func:async(t,n,i)=>e(t[0]),_signature:[]},getQueryParameter:{_func:(e,n,i)=>{const s=t(e[0]);if(!s)return i.globals.form.logger.error("Argument is missing in getQueryParameter. A parameter is expected"),"";const r=i.globals.form?.properties?.queryParams;if(r){if(void 0!==r[s])return r[s];const e=s.toLowerCase();for(const[t,n]of Object.entries(r))if(t.toLowerCase()===e)return n}try{const e=new URLSearchParams(window?.location?.search||""),t=e.get(s)||Array.from(e.entries()).find((([e])=>e.toLowerCase()===s.toLowerCase()))?.[1];if(null!=t)return t}catch(e){i.globals.form.logger.warn("Error reading URL parameters:",e)}return""},_signature:[]},getBrowserDetail:{_func:(e,n,i)=>{const s=t(e[0]);return s?i.globals.form?.properties?.browserDetails?.[s]?i.globals.form.properties.browserDetails[s]:"undefined"!=typeof navigator&&s in navigator?navigator[s]||"":(i.globals.form.logger.warn(`Invalid or unsupported browser detail requested: "${s}"`),""):(i.globals.form.logger.error("Argument is missing in getBrowserDetail. A parameter is expected"),"")},_signature:[]},getURLDetail:{_func:(e,n,i)=>{const s=t(e[0]);return s?i.globals.form?.properties?.urlDetails?.[s]?i.globals.form.properties.urlDetails[s]:"undefined"!=typeof window&&void 0!==window.location&&s in window.location?window.location[s]||"":(i.globals.form.logger.warn(`Invalid or unsupported url parameter requested: "${s}"`),""):(i.globals.form.logger.error("Argument is missing in getURLDetail. A parameter is expected"),"")},_signature:[]},getRelativeInstanceIndex:{_func:(t,n,i)=>{if(!Array.isArray(t[0])||0===t[0].length)return-1;const s=e(t[0])[0].$parent,r=i.globals.$field,a=s.$qualifiedName,o=r.$qualifiedName;if(o.startsWith(a+"[")){const e=a.length+1,t=o.indexOf("]",e);if(-1!==t){const n=Number(o.slice(e,t));if(!Number.isNaN(n))return n}}return s.length-1},_signature:[]},today:{_func:()=>{const e=new Date(Date.now());return new Date(e.getFullYear(),e.getMonth(),e.getDate())/864e5},_signature:[]},formatInput:{_func:e=>{const t=e[0],n=e[1];if(!t||!n)return t;const i=String(t).replace(/\D/g,"");switch(String(n).toLowerCase()){case"phonenumber":if(i.length>=10){return`(${i.substring(0,3)}) ${i.substring(3,6)}-${i.substring(6,10)}`}if(i.length>=7){return`(${i.substring(0,3)}) ${i.substring(3,7)}`}return i;case"socialsecuritynumber":if(i.length>=9){return`${i.substring(0,3)}-${i.substring(3,5)}-${i.substring(5,9)}`}return i;case"email-alphanumeric":{const e=String(t).replace(/[^a-zA-Z0-9]/g,"");return e.length>0?`${e}@example.com`:t}case"zipcode":return i.length>=5?i.substring(0,5):i;default:return t}},_signature:[]}};return{...n,...mt.getInstance().customFunctions}}}const ft=mt.getInstance();class gt{#e;#t;#n;#i=!0;constructor(e){const t=e.match(/([^.]+)\.([^.]+)(?:\.(.+))?/);if(!t)throw new Error("Invalid version string "+e);if(this.#t=+t[1],this.#e=+t[2],this.#n=t[3]?+t[3]:0,isNaN(this.#t)||isNaN(this.#e)||isNaN(this.#n))throw new Error("Invalid version string "+e)}get major(){return this.#t}get minor(){return this.#e}get subversion(){return this.#n}completeMatch(e){return this.major===e.major&&this.minor===e.minor&&this.#n===e.subversion}lessThan(e){return this.major<e.major||this.major===e.major&&this.minor<e.minor||this.major===e.major&&this.minor===e.minor&&this.#n<e.subversion}toString(){return`${this.major}.${this.minor}.${this.subversion}`}valueOf(){return this.toString()}}const _t=new gt("0.13"),yt=new gt("0.13");class vt extends Ke{_ruleEngine;_eventQueue;additionalSubmitMetadata={};_fields={};_ids;_invalidFields=[];_exportDataAttachmentMap={};promises=[];_captcha=null;constructor(e,i,a,o=new rt,l="off",u="create"){super(e,{fieldFactory:i,mode:u}),this._ruleEngine=a,this._eventQueue=o,this._logger=new it(l),this._applyDefaultsInModel(),"create"===u&&(this.queueEvent(new n),"deps"===this.changeEventBehaviour?this.queueEvent(new s({changes:[]})):this.queueEvent(new t)),this._ids=function*(e=50){const t=function(){const t=[];for(let n=0;n<e;n++)t.push(ye(10));return t},n={};let i=t();do{let e=i.pop();for(;e in n;)0===i.length&&(i=t()),e=i.pop();n[e]=!0,yield i.pop(),0===i.length&&(i=t())}while(i.length>0)}(),this.bindToDataModel(new te("$form",{})),this._initialize(u),"create"===u&&this.queueEvent(new r)}addPromises(e){this.promises.push(e)}async waitForPromises(){let e=0;for(;this.promises.length>e;)e=this.promises.length,await Promise.all(this.promises);this.promises=[]}_applyDefaultsInModel(){const e=this.specVersion;this._jsonModel.properties=this._jsonModel.properties||{},this._jsonModel.fieldType=this._jsonModel.fieldType||"form",(e.lessThan(yt)||"string"!=typeof this._jsonModel.properties["fd:changeEventBehaviour"])&&(this._jsonModel.properties["fd:changeEventBehaviour"]="self")}_logger;get activeField(){return this._findActiveField(this)}_findActiveField(e){return e?.isContainer?this._findActiveField(e?.activeChild):e}get logger(){return this._logger}get changeEventBehaviour(){return"deps"===this.properties["fd:changeEventBehaviour"]?"deps":"self"}dataRefRegex=/("[^"]+?"|[^.]+?)(?:\.|$)/g;get metaData(){const e=this._jsonModel.metadata||{};return new et(e)}get action(){return this._jsonModel.action}get isFragment(){return!1}importData(e){this.bindToDataModel(new te("$form",e)),this.syncDataAndFormModel(this.getDataNode()),this._eventQueue.runPendingQueue()}exportData(e={}){this._exportDataAttachmentMap=e;const t=this.getDataNode()?.$value;return this._exportDataAttachmentMap={},t}setAdditionalSubmitMetadata(e){this.additionalSubmitMetadata={...this.additionalSubmitMetadata,...e}}get specVersion(){if("string"!=typeof this._jsonModel.adaptiveform)return _t;try{return new gt(this._jsonModel.adaptiveform)}catch(e){return console.log(e),console.log("Falling back to default version"+_t.toString()),_t}}resolveQualifiedName(e){if(this.qualifiedName===e)return this;let t=null;return this.visit((n=>{n.qualifiedName===e&&(t=n)})),t}exportSubmitMetaData(){return this.withDependencyTrackingControl(!0,(()=>{const e={};this.visit((t=>{"captcha"===t.fieldType&&(e[t.qualifiedName]=t.value)}));const t={},n=this.properties["fd:draftId"]||"";n&&(t["fd:draftId"]=n);const i=this.properties["fd:dor"];if(i&&"none"!==i.dorType){const e=i["fd:excludeFromDoRIfHidden"];let n=[];n=Object.values(this._fields).filter((t=>!1===t.enabled||e&&!1===t.visible)).map((e=>e.qualifiedName.split(".").slice(1).map((e=>e.match(/\[\d+\]$/)?e:""!==e?`${e}[0]`:e)).join("."))),n&&n.length>0&&(t.excludeFromDoR=n)}Object.keys(t).length>0&&this.setAdditionalSubmitMetadata(t);const s={lang:this.lang,captchaInfo:e,...this.additionalSubmitMetadata};return new tt(s)}))}#s(e){return e.filter((e=>!0===e.visible))}#r(e){const t=this.#s(e.items);return t&&t.length>0?t[0]:null}#a(e){if(!e.isContainer)return void(e.parent.activeChild=e);this.#o(e);const t=e.activeChild||this.#r(e);null!==t?this.#a(t):e.parent.activeChild=e}#l(e,t){return e<t.length-1?t[e+1]:null}#u(e,t){return e>0?t[e-1]:null}#o(e){const t=e.parent;null!=t&&null!=t.activeChild&&(t.activeChild=null)}setFocus(e,t){const n=this._ruleEngine.getDependencyTracking();this._ruleEngine.setDependencyTracking(!1);try{if(!t)return this.#o(e),void this.#a(e);const n=e?.isContainer?e:e.parent,i=this.#s(n.items);let s=n.activeChild,r=null!==s?i.indexOf(s):-1;if(null===n.activeChild)return this.#a(i[0]),void(r=0);t===q.NEXT_ITEM?s=this.#l(r,i):t===q.PREVIOUS_ITEM&&(s=this.#u(r,i)),null!==s&&this.#a(s)}finally{this._ruleEngine.setDependencyTracking(n)}}getState(e=!1){const t=this,n=super.getState(!1,e);return n.id="$form",Object.defineProperty(n,"data",{get:function(){return t.exportData()}}),Object.defineProperty(n,"attachments",{get:function(){return be(t)}}),n}get type(){return"object"}isTransparent(){return!1}get form(){return this}get ruleEngine(){return this._ruleEngine}getUniqueId(e){if(e&&!this._idSet?.has(e))return this._idSet?.add(e),e;if(null==this._ids)return"";const t=this._ids.next().value;return this._idSet?.add(t),t}clearIdRegistry(){this._idSet?.clear()}fieldAdded(e){"captcha"!==e.fieldType||this._captcha||(this._captcha=e),this._fields[e.id]=e,e.subscribe((e=>{-1===this._invalidFields.indexOf(e.target.id)&&this._invalidFields.push(e.target.id)}),"invalid"),e.subscribe((e=>{const t=this._invalidFields.indexOf(e.target.id);t>-1&&this._invalidFields.splice(t,1)}),"valid"),e.subscribe((e=>{const t=e.target.getState();if(e.payload.changes.length>0&&t){const n=e=>e&&"object"==typeof e?Array.isArray(e)?e.map(n):{...e}:e,i=e.payload.changes.map((({propertyName:e,currentValue:t,prevValue:i})=>({propertyName:e,currentValue:n(t),prevValue:n(i)}))),s=new a(i,t,e.payload.eventSource);this.notifyDependents(s)}}))}visit(e){this.traverseChild(this,e)}traverseChild(e,t){e.items.forEach((e=>{e.isContainer&&this.traverseChild(e,t),t(e)}))}validate(){const e=super.validate();return this.dispatch(new o(e)),e}isValid(){return 0===this._invalidFields.length}dispatch(e){"submit"===e.type?(super.queueEvent(e),this._eventQueue.runPendingQueue()):super.dispatch(e)}submit(e,t){const n=e?.payload?.validate_form;if(!1===n||0===this.validate().length){const n=e?.payload||{},i=n?.success?n?.success:"submitSuccess",s=n?.error?n?.error:"submitError",r=n.action||this.action,a=n.metadata||{submitMetadata:this.exportSubmitMetaData()};(async(e,t,n,i="multipart/form-data",s=null,r="",a=null)=>{const o=r||e.form.action;let l=s;const u=await Me(e.form,!0);"object"==typeof l&&null!=l||(l=e.form.exportData(u));let d=i;const h={data:l,...a};let c=h;(Object.keys(u).length>0||"multipart/form-data"===i)&&(c=ct(h,u),d="multipart/form-data"),await dt(e,o,"POST",c,t,n,{"Content-Type":d})})(t,i,s,n?.save_as||n?.submit_as,n?.data,r,a)}}save(e,t){const n=e?.payload||{};n.save_as="multipart/form-data",n.metadata={draftMetadata:{lang:this.lang,"fd:draftId":this.properties["fd:draftId"]||""}},n.success="custom:saveSuccess",n.error="custom:saveError",this.submit(e,t),this.subscribe((e=>{this._saveSuccess(e)}),"saveSuccess")}_saveSuccess(e){const t=e?.payload?.body?.draftId||"",n=this.properties;t&&n&&(n["fd:draftId"]=t)}reset(){super.reset(),this._invalidFields=[]}getElement(e){return e==this.id?this:this._fields[e]}get qualifiedName(){return"$form"}getEventQueue(){return this._eventQueue}get name(){return"$form"}get value(){return null}get id(){return this._jsonModel.id||"$form"}get title(){return this._jsonModel.title||""}get captcha(){return this._captcha}}function Mt(e){if(null==e){const t=(new Intl.DateTimeFormat).resolvedOptions();e=t.locale}return t=>function(e,t){if(null===e)return 0;const n=+e;if(!isNaN(n))return n;if(t){const n=I(e,t,!0);if(n!==e)return $(n)}return 0}(t,e)}class bt{_context;_globalNames=["$form","$field","$event"];customFunctions;debugInfo=[];dependencyTracking=!0;constructor(){this.customFunctions=ft.getFunctions()}compileRule(e,t){const n=new w(this.customFunctions,Mt(t),this.debugInfo);return{formula:n,ast:n.compile(e,this._globalNames)}}execute(e,t,n,i=!1,s){const{formula:r,ast:a}=e,o=this._context;let u;this._context=n;try{u=r.run(a,t,"en-US",n)}catch(e){if(this._context?.form?.logger?.error(e),this._context?.form){const t=this._context?.field,n=t?.name,i=e instanceof Error?e.message:String(e),r={name:n,error:n?`Script execution error in field "${n}": ${i}. Expression: ${s}`:`Script execution error: ${i}. Expression: ${s}`,event:this._context?.$event?.type,rule:s,stack:e instanceof Error?e.stack:void 0};this._context.form.dispatch(new l(r,!1))}}if(this.debugInfo.length)for(this._context?.form?.logger?.warn(`Form rule expression string: ${s}`);this.debugInfo.length>0;)this._context?.form?.logger?.warn(this.debugInfo.pop());let d=u;return i&&"object"==typeof u&&null!==u&&(d=Object.getPrototypeOf(u).valueOf.call(u)),this._context=o,d}trackDependency(e,t){this.dependencyTracking&&this._context&&void 0!==this._context.field&&this._context.field!==e&&e._addDependent(this._context.field,t)}setDependencyTracking(e){this.dependencyTracking=e}getDependencyTracking(){return this.dependencyTracking}}class jt extends Ke{constructor(e,i){super(e,i),"restore"!==i.mode&&(this._applyDefaults(),this.queueEvent(new n),this.queueEvent(new t))}_getDefaults(){return{...super._getDefaults(),visible:!0,required:!1,label:{visible:!0,richText:!1}}}_applyDefaults(){super._applyDefaultsInModel(),this._jsonModel.dataRef&&void 0===this._jsonModel.type&&(this._jsonModel.type="object")}get type(){const e=super.type;if("array"===e||"object"===e)return e}get items(){return super.items?super.items:[]}get value(){return this.getDataNode()?.$value}get fieldType(){return"panel"}}class Et extends jt{get maxOccur(){return this._jsonModel.maxItems}set maxOccur(e){this.maxItems=e}get minOccur(){return this.minItems}addInstance(e){return this.addItem(e)}removeInstance(e){return this.removeItem(e)}}C([function(e,t,n){const i=n.get;null!=i&&(n.get=function(){return this.ruleEngine.trackDependency(this,t),i.call(this)})}],Et.prototype,"maxOccur",null),C([function(e,t,n){const i=n.get;null!=i&&(n.get=function(){return this.ruleEngine.trackDependency(this,t),i.call(this)})}],Et.prototype,"minOccur",null);const xt=["string","number","integer","boolean","file","string[]","number[]","integer[]","boolean[]","file[]","array","object"];class wt extends Je{_ruleNodeReference=[];_hasValueBeenSet=!1;get hasValueBeenSet(){return this._hasValueBeenSet}constructor(e,i){super(e,i),"restore"!==i.mode&&(this._applyDefaults(),this.queueEvent(new n),"deps"===this.form.changeEventBehaviour?this.queueEvent(new s({changes:[]})):this.queueEvent(new t))}_initialize(){super._initialize(),this.setupRuleNode()}ruleNodeReference(){return this.type?.endsWith("[]")?this._ruleNodeReference=[]:this._ruleNodeReference=this,this._ruleNodeReference}_getDefaults(){return{readOnly:!1,enabled:!0,visible:!0,label:{visible:!0,richText:!1},required:!1,type:this._getFallbackType()}}_getFallbackType(){const e=this._jsonModel.type;let t=e;if("string"!=typeof e||-1===xt.indexOf(e)){const e=this.enum;if(t=typeof e?.[0],"undefined"===t&&void 0!==this._jsonModel.default&&(t=this._jsonModel.default instanceof Array&&this._jsonModel.default.length>0?typeof this._jsonModel.default[0]+"[]":typeof this._jsonModel.default),0===t.indexOf("undefined")){t={"text-input":"string","multiline-input":"string","number-input":"number","date-input":"string","date-time":"string",email:"string","plain-text":"string",image:"string",checkbox:"boolean"}[this.fieldType]}}return t}_applyDefaults(){super._applyDefaultsInModel(),this.coerceParam("required","boolean"),this.coerceParam("readOnly","boolean"),this.coerceParam("enabled","boolean");const e=this._jsonModel.type;"string"==typeof e&&-1!==xt.indexOf(e)||(this._jsonModel.type=this._getFallbackType()),-1===["plain-text","image"].indexOf(this.fieldType)?this._jsonModel.value=void 0:"image"===this.fieldType?this._jsonModel.value=this._jsonModel?.properties?.["fd:repoPath"]??this._jsonModel.value:this._jsonModel.default=this._jsonModel.default||this._jsonModel.value;if(void 0===this._jsonModel.value){const e=qe.type(this.getInternalType()||"string",this._jsonModel.default);this._jsonModel.value=e.value}if("string"!==this._jsonModel.type&&this.unset("emptyValue"),void 0===this._jsonModel.fieldType&&(this.form.logger.debug("fieldType property is mandatory. Please ensure all the fields have a fieldType"),this._jsonModel.viewType?(this._jsonModel.viewType.startsWith("custom:")?this.form.logger.error("viewType property has been removed. For custom types, use :type property"):this.form.logger.error("viewType property has been removed. Use fieldType property"),this._jsonModel.fieldType=this._jsonModel.viewType):this._jsonModel.fieldType=B(this._jsonModel)),void 0===this._jsonModel.enum){"boolean"===this._jsonModel.type&&(this._jsonModel.enum=[!0,!1])}else for(void 0===this._jsonModel.enumNames&&(this._jsonModel.enumNames=this._jsonModel.enum.map((e=>e.toString())));this._jsonModel.enumNames.length<this._jsonModel.enum.length;)this._jsonModel.enumNames.push(this._jsonModel.enum[this._jsonModel.enumNames.length].toString());const t=["minimum","maximum","exclusiveMinimum","exclusiveMaximum"];"string"!==this._jsonModel.type?"file-input"===this._jsonModel.fieldType?this.unset("pattern","minLength","maxLength"):this.unset("format","pattern","minLength","maxLength"):"date-input"===this._jsonModel.fieldType&&(this._jsonModel.format="date"),this.coerceParam("minLength","number"),this.coerceParam("maxLength","number"),"number"!==this._jsonModel.type&&"date"!==this._jsonModel.format&&"date-time"!==this._jsonModel.format&&"integer"!==this._jsonModel.type&&this.unset("step",...t),t.forEach((e=>{this.coerceParam(e,"integer"===this._jsonModel.type?"number":this._jsonModel.type)})),"number"!=typeof this._jsonModel.step&&this.coerceParam("step","number")}unset(...e){e.forEach((e=>this._jsonModel[e]=void 0))}coerceParam(e,t){const n=this._jsonModel[e];if(void 0!==n&&typeof n!==t){this.form.logger.info(`${e} is not of type ${t}. Trying to coerce.`);try{this._jsonModel[e]=((e,t)=>{let n;switch(t){case"string":return e+"";case"number":if(n=+e,!isNaN(n))return n;break;case"boolean":if("string"==typeof e)return"true"===e;if("number"==typeof e)return 0!==e}throw`${e} has invalid type. Expected : ${t}, Actual ${typeof e}`})(n,t)}catch(t){this.form.logger.warn(t),this.unset(e)}}}get editFormat(){return this.withCategory(this._jsonModel.editFormat)}get displayFormat(){return this.withCategory(this._jsonModel.displayFormat)}get displayValueExpression(){return this._jsonModel.displayValueExpression}get placeholder(){return this._jsonModel.placeholder}get readOnly(){return void 0!==this.parent.readOnly&&!0===this.parent.readOnly||this._jsonModel.readOnly}set readOnly(e){this._setProperty("readOnly",e)}get enabled(){const e=this.parent?.enabled;return void 0!==e?!!e&&this._jsonModel.enabled:this._jsonModel.enabled}set enabled(e){this._setProperty("enabled",e)}get valid(){return this._jsonModel?.validity?.valid}set valid(e){const t={valid:e,...e?{}:{customConstraint:!0}};this._setProperty("valid",e),this._setProperty("validity",t)}get validity(){return this._jsonModel.validity}get emptyValue(){return"null"===this._jsonModel.emptyValue?null:""===this._jsonModel.emptyValue&&"string"===this.type?"":void 0}get enum(){return this._jsonModel.enum}set enum(e){this._setProperty("enum",e)}get enumNames(){return this._jsonModel.enumNames}set enumNames(e){this._setProperty("enumNames",e)}get required(){return this._jsonModel.required||!1}set required(e){this._setProperty("required",e)}get maximum(){if("number"===this.type||"date"===this.format||"date-time"===this.format||"integer"===this.type)return this._jsonModel.maximum}set maximum(e){"number"!==this.type&&"date"!==this.format&&"date-time"!==this.format&&"integer"!==this.type||this._setProperty("maximum",e)}get minimum(){if("number"===this.type||"date"===this.format||"date-time"===this.format||"integer"===this.type)return this._jsonModel.minimum}set minimum(e){"number"!==this.type&&"date"!==this.format&&"date-time"!==this.format&&"integer"!==this.type||this._setProperty("minimum",e)}withCategory(e){if(e){const t=e?.match(/^(?:date|num)\|/);if(null===t)return"date"===this.format?e=`date|${e}`:"number"!==this.type&&"integer"!==this.type||(e=`num|${e}`),e}return e}get editValue(){const e=this.editFormat;if(!e||!this.isNotEmpty(this.value)||!1===this.valid)return this.value;try{return T(this.value,this.lang,e)}catch(e){return this.value}}get displayValue(){if(this.displayValueExpression&&"string"==typeof this.displayValueExpression&&0!==this.displayValueExpression.length)return this.executeExpression(this.displayValueExpression);const e=this.displayFormat;if(!e||!this.isNotEmpty(this.value)||!0===this?.validity?.typeMismatch||("date"===this.format||"date-time"===this.format)&&!0===this?.validity?.formatMismatch)return this.value;try{return T(this.value,this.lang,e)}catch(e){return this.value}}getDataNodeValue(e){return this.isEmpty()?this.emptyValue:e}updateDataNodeAndTypedValue(e){const t=this.getDataNode();if(Ue.indexOf(this.fieldType)>-1&&void 0!==t&&t!==ee)return;const n=this._getConstraintObject().type(this.getInternalType()||"string",e),i=this._setProperty("value",n.value,!1);return i.length>0&&(this._hasValueBeenSet=!0,this._updateRuleNodeReference(n.value),void 0!==t&&t.setValue(this.getDataNodeValue(this._jsonModel.value),this._jsonModel.value,this)),i}get value(){return void 0===this._jsonModel.value?null:this._jsonModel.value}set value(e){const t=this.updateDataNodeAndTypedValue(e);let n={valid:!0},i="type";if(t?.length>0){let r={};const a=qe.type(this.getInternalType()||"string",e);if(this.parent.uniqueItems&&"array"===this.parent.type&&(n=qe.uniqueItems(this.parent.uniqueItems,this.parent.getDataNode().$value),i="uniqueItems"),a.valid&&n.valid)r=this.evaluateConstraints();else{const e=a.valid&&n.valid,t={valid:e,errorMessage:a.valid&&n.valid?"":this.getErrorMessage("type"),...e?{}:{validationMessage:e?"":this.getErrorMessage(i),validity:{valid:e,[F[i]]:!0}}};r=this._applyUpdates(["valid","errorMessage","validationMessage","validity"],t)}r.valid&&this.triggerValidationEvent(r);const o=new s({changes:t.concat(Object.values(r)),eventSource:this._eventSource});this.dispatch(o)}}uiChange(e){this._eventSource=R.UI,"value"in e.payload?this.value=e.payload.value:"checked"in e.payload&&(this.checked=e.payload.checked),this._eventSource=R.CODE}reset(){const e=this.updateDataNodeAndTypedValue(this.default);if(!e)return;const t={valid:void 0,errorMessage:"",validationMessage:"",validity:{valid:void 0}},n=this._applyUpdates(["valid","errorMessage","validationMessage","validity"],t),i=new s({changes:e.concat(Object.values(n))});this.dispatch(i)}_updateRuleNodeReference(e){if(this.type?.endsWith("[]"))if(null!=e)for(e.forEach(((e,t)=>{this._ruleNodeReference[t]=e}));e.length!==this._ruleNodeReference.length;)this._ruleNodeReference.pop();else for(;0!==this._ruleNodeReference.length;)this._ruleNodeReference.pop()}getInternalType(){return this.type}valueOf(){const e=this[He],t=void 0===e?this:e;return t.ruleEngine.trackDependency(t,"value"),t._jsonModel.value||null}toString(){const e=this[He],t=void 0===e?this:e;return t._jsonModel.value?.toString()||""}getErrorMessage(e){const t=e,n=F[t],i={...k,...P};return this._jsonModel.constraintMessages?.["exclusiveMaximum"===t?"maximum":"exclusiveMinimum"===t?"minimum":t]||((e,t=[])=>e?.replace(/\${(\d+)}/g,((e,n)=>{const i=t[n];return void 0!==i?i:e})))(i[n],[this._jsonModel[t]])}get errorMessage(){return this._jsonModel.errorMessage}set errorMessage(e){this._setProperty("errorMessage",e),this._setProperty("validationMessage",e)}set constraintMessage(e){if(Array.isArray(e)){const t={...this._jsonModel.constraintMessages};e.forEach((({type:e,message:n})=>{t[e]=n})),this._setProperty("constraintMessages",t)}else{const t={...this._jsonModel.constraintMessages,[e.type]:e.message};this._setProperty("constraintMessages",t)}}_getConstraintObject(){return qe}isArrayType(){return!!this.type&&this.type.indexOf("[]")>-1}checkEnum(e,t){if(!0===this._jsonModel.enforceEnum&&null!=e){const n=t.enum;return e instanceof Array&&this.isArrayType()?e.every((e=>n(this._jsonModel.enum||[],e).valid)):n(this._jsonModel.enum||[],e).valid}return!0}checkStep(){const e=this._jsonModel.value,t=this._jsonModel.step;if("number"==typeof t){const n=t.toString().split(".")?.[1]?.length||0,i=Math.pow(10,n),s=t*i,r=e*i,a=(this._jsonModel.minimum||this._jsonModel.default||0)*i,o=(r-a)/s,l=Math.abs(r-a)%s<.001;let u,d;return l||(u=(Math.ceil(o)*s+a)/i,d=(u-s)/i),{valid:l,next:u,prev:d}}return{valid:!0}}checkValidationExpression(){const e=this._jsonModel.validationExpression;return"string"!=typeof e||0===e.length||this.executeExpression(e)}getConstraints(){switch(this.type){case"string":switch(this.format){case"date":return Pe.date;case"date-time":return Pe.datetime;case"email":return Pe.email;case"binary":case"data-url":return Pe.file;default:return Pe.string}case"file":return Pe.file;case"number":case"integer":return Pe.number}return this.isArrayType()?Pe.array:[]}get format(){if(void 0===this._jsonModel.format&&"string"===this.type)switch(this.fieldType){case"date-input":this._jsonModel.format="date";break;case"date-time":this._jsonModel.format="date-time"}return this._jsonModel.format}get enforceEnum(){return this._jsonModel.enforceEnum}get tooltip(){return this._jsonModel.tooltip}get maxLength(){return this._jsonModel.maxLength}get minLength(){return this._jsonModel.minLength}get pattern(){return this._jsonModel.pattern}get step(){if("number"===this.type||"date"===this.format)return this._jsonModel.step}get exclusiveMinimum(){if("number"===this.type||"date"===this.format||"integer"===this.type)return this._jsonModel.exclusiveMinimum}set exclusiveMinimum(e){"number"!==this.type&&"date"!==this.format&&"integer"!==this.type||(this._jsonModel.exclusiveMinimum=e)}get exclusiveMaximum(){if("number"===this.type||"date"===this.format||"integer"===this.type)return this._jsonModel.exclusiveMaximum}set exclusiveMaximum(e){"number"!==this.type&&"date"!==this.format&&"integer"!==this.type||(this._jsonModel.exclusiveMaximum=e)}get default(){return this._jsonModel.default}isNotEmpty(e){return null!=e&&""!==e}evaluateConstraints(){let e="type";const t=this._jsonModel,n=this._jsonModel.value,i=this._getConstraintObject(),s=this.getConstraints();let r=!0;if(r&&(r=i.required(this.required,n).valid&&(!this.isArrayType()||!this.required||n.length>0),e="required"),r&&this.isNotEmpty(n)){const a=s.find((e=>{if(e in t&&void 0!==t[e]){const s=t[e],r=i[e];return n instanceof Array&&this.isArrayType()?-1!==Pe.array.indexOf(e)?!r(s,n).valid:n.some((e=>!r(s,e).valid)):"function"==typeof r&&!r(s,n).valid}return!1}));null!=a?(r=!1,e=a):(r=this.checkEnum(n,i),e="enum",r&&"number"===this.type&&(r=this.checkStep().valid,e="step"),r&&(r=this.checkValidationExpression(),e="validationExpression"))}r||this.form.logger.info(`${e} constraint evaluation failed ${this._jsonModel[e]}. Received ${this._jsonModel.value}`);const a={valid:r,errorMessage:r?"":this.getErrorMessage(e),validationMessage:r?"":this.getErrorMessage(e),validity:{valid:r,...r?{}:{[F[e]]:!0}}};return this._applyUpdates(["valid","errorMessage","validationMessage","validity"],a)}triggerValidationEvent(e){e.validity&&this.#d()}#d(){this.validity.valid?this.dispatch(new u):this.dispatch(new d)}validate(){if(!1===this.visible)return[];if(!1===this.valid&&this.errorMessage&&this?.validity?.customConstraint)return[new L(this.id,[this._jsonModel.errorMessage])];const e=this.evaluateConstraints();return this.#d(),e.validity&&this.notifyDependents(new s({changes:Object.values(e)})),this.valid?[]:[new L(this.id,[this._jsonModel.errorMessage])]}syncDataAndFormModel(t){if(void 0!==t&&t!==ee&&t.$value!==this._jsonModel.value){const n=e("value",t.$value,this._jsonModel.value);this._jsonModel.value=t.$value,this.queueEvent(n)}}defaultDataModel(e){const t=Ue.indexOf(this.fieldType)>-1?void 0:this.getDataNodeValue(this._jsonModel.value);return new K(e,t,this.type||"string")}getState(e=!1,t=!1){return{...super.getState(t),editFormat:this.editFormat,displayFormat:this.displayFormat,editValue:this.editValue,displayValue:this.displayValue,enabled:this.enabled,readOnly:this.readOnly}}markAsInvalid(e,t=null){const n={valid:!1,errorMessage:e,validationMessage:e,validity:{valid:!1,...null!=t?{[F[t]]:!0}:{customConstraint:!0}}},i=this._applyUpdates(["valid","errorMessage","validationMessage","validity"],n),r=new s({changes:[].concat(Object.values(i))});0!==r.payload.changes.length&&(this.triggerValidationEvent(i),this.dispatch(r))}}function Tt(e,t){return e.replace(";base64",`;name=${encodeURIComponent(t)};base64`)}async function It(e){const{name:t,size:n,type:i}=e;return await new Promise(((s,r)=>{const a=new FileReader;a.onload=e=>{s(new fe({data:Tt(e.target.result,t),type:i,name:t,size:n}))},a.readAsDataURL(e.data)}))}C([function(e,t,n){const i=n.get;null!=i&&(n.get=function(){return this.ruleEngine.trackDependency(this,t),i.call(this)})},Ge("button","image","plain-text")],wt.prototype,"readOnly",null),C([function(e,t,n){const i=n.get;null!=i&&(n.get=function(){return this.ruleEngine.trackDependency(this,t),i.call(this)})},Ge("image","plain-text")],wt.prototype,"enabled",null),C([function(e,t,n){const i=n.get;null!=i&&(n.get=function(){return this.ruleEngine.trackDependency(this,t),i.call(this)})}],wt.prototype,"valid",null),C([function(e,t,n){const i=n.get;null!=i&&(n.get=function(){return this.ruleEngine.trackDependency(this,t),i.call(this)})}],wt.prototype,"validity",null),C([function(e,t,n){const i=n.get;null!=i&&(n.get=function(){return this.ruleEngine.trackDependency(this,t),i.call(this)})}],wt.prototype,"enum",null),C([function(e,t,n){const i=n.get;null!=i&&(n.get=function(){return this.ruleEngine.trackDependency(this,t),i.call(this)})}],wt.prototype,"enumNames",null),C([function(e,t,n){const i=n.get;null!=i&&(n.get=function(){return this.ruleEngine.trackDependency(this,t),i.call(this)})}],wt.prototype,"required",null),C([We("date-input","number-input")],wt.prototype,"editValue",null),C([function(e,t,n){const i=n.get;null!=i&&(n.get=function(){return this.ruleEngine.trackDependency(this,t),i.call(this)})}],wt.prototype,"value",null),C([function(e,t,n){const i=n.get;null!=i&&(n.get=function(){return this.ruleEngine.trackDependency(this,t),i.call(this)})}],wt.prototype,"errorMessage",null),C([We("text-input","date-input","file-input","email","datetime-input")],wt.prototype,"format",null),C([We("text-input")],wt.prototype,"maxLength",null),C([We("text-input")],wt.prototype,"minLength",null),C([We("text-input")],wt.prototype,"pattern",null),C([function(e,t,n){const i=n.get;null!=i&&(n.get=function(){return this.ruleEngine.trackDependency(this,t),i.call(this)})}],wt.prototype,"exclusiveMinimum",null),C([function(e,t,n){const i=n.get;null!=i&&(n.get=function(){return this.ruleEngine.trackDependency(this,t),i.call(this)})}],wt.prototype,"exclusiveMaximum",null);class $t extends wt{_getDefaults(){return{...super._getDefaults(),accept:["audio/*","video/*","image/*","text/*","application/pdf"],maxFileSize:"2MB"}}_getFallbackType(){return"file"}get maxFileSize(){return je(this._jsonModel.maxFileSize)}get accept(){return this._jsonModel.accept}_applyUpdates(e,t){return e.reduce(((e,n)=>{const i=this._jsonModel[n],s=t[n];return s!==i&&(e[n]={propertyName:n,currentValue:s,prevValue:i},this._jsonModel[n]=i instanceof fe&&"object"==typeof s&&"value"===n?new fe({...i,data:s.data}):s),e}),{})}getInternalType(){return this.type?.endsWith("[]")?"file[]":"file"}getDataNodeValue(e){let t=e;return null!=t&&("string"===this.type?t=t.data?.toString():"string[]"===this.type&&(t=t instanceof Array?t:[t],t=t.map((e=>e?.data?.toString())))),t}async serialize(){const e=this._jsonModel.value;if(void 0===e)return null;var t;return await(t=e instanceof Array?e:[e],Promise.all([].map.call(t,It)))}syncDataAndFormModel(t){if(void 0!==t&&t!==ee){const n=t?.$value;if(null!=n){const t=qe.type(this.getInternalType(),n);t.valid||this.form.logger.debug(`unable to bind ${this.name} to data`),this.form.getEventQueue().queue(this,e("value",t.value,this._jsonModel.value)),this._jsonModel.value=t.value}else this._jsonModel.value=null}}}class Dt extends wt{offValue(){const e=this.enum;return e.length>1?e[1]:null}_getConstraintObject(){const e={...super._getConstraintObject()};var t;return e.required=(t=this.offValue(),(e,n)=>({valid:qe.required(e,n).valid&&(!e||n!=t),value:n})),e}_applyDefaults(){"boolean"==typeof this._jsonModel.checked&&(this._jsonModel.checked?this._jsonModel.default=this._jsonModel.enum?.[0]:this._jsonModel.default=this._jsonModel.enum?.[1]),super._applyDefaults()}_getDefaults(){return{...super._getDefaults(),enforceEnum:!0}}get enum(){return this._jsonModel.enum||[]}updateDataNodeAndTypedValue(e){const t=super.updateDataNodeAndTypedValue(e),n=t.find((e=>"value"===e.propertyName));if(n){const e=n.prevValue===this._jsonModel.enum?.[0],i=n.currentValue===this._jsonModel.enum?.[0];e!==i&&t.push({propertyName:"checked",prevValue:e,currentValue:i})}return t}set checked(e){this.value=e?this._jsonModel.enum?.[0]:this._jsonModel.enum?.[1]}get checked(){return this.value===this._jsonModel.enum?.[0]}getState(e=!1,t=!1){return{...super.getState(e,t),checked:this.checked}}}C([function(e,t,n){const i=n.get;null!=i&&(n.get=function(){return this.ruleEngine.trackDependency(this,t),i.call(this)})}],Dt.prototype,"checked",null);class Nt extends wt{constructor(e,t){super(e,t)}_getFallbackType(){const e=super._getFallbackType();return"string"==typeof e?`${e}[]`:"string[]"}_getDefaults(){return{...super._getDefaults(),enforceEnum:!0,enum:[]}}}class St extends wt{locale;_dataFormat="yyyy-MM-dd";_applyDefaults(){super._applyDefaults(),this.locale=(new Intl.DateTimeFormat).resolvedOptions().locale,this._jsonModel.editFormat||(this._jsonModel.editFormat="short"),this._jsonModel.displayFormat||(this._jsonModel.displayFormat=this._jsonModel.editFormat),this._jsonModel.placeholder||(this._jsonModel.placeholder=D(this._jsonModel.editFormat,this.locale))}#h(e){const t=N(e);return isNaN(t)?null:S(t,this.locale,this._dataFormat)}get value(){return super.value}set value(e){if("number"==typeof e){const t=this.#h(e);t&&(super.value=t)}else if("short"!==this._jsonModel.editFormat&&"date|short"!==this._jsonModel.editFormat){const t=O(e,this.locale,this._jsonModel.editFormat)||O(e,this.locale,"yyyy-MM-dd");t instanceof Date?super.value=S(t,this.locale,this._dataFormat):super.value=e}else super.value=e}get minimum(){return super.minimum}set minimum(e){if("number"==typeof e){const t=this.#h(e);t&&(super.minimum=t)}else"string"==typeof e&&(super.minimum=e)}get maximum(){return super.maximum}set maximum(e){if("number"==typeof e){const t=this.#h(e);t&&(super.maximum=t)}else"string"==typeof e&&(super.maximum=e)}}class Ot extends St{_dataFormat="yyyy-MM-ddTHH:mm";_applyDefaults(){super._applyDefaults()}get value(){return super.value}set value(e){super.value=e}}class Ct extends wt{_getDefaults(){return{...super._getDefaults(),format:"email"}}}class At extends wt{_captchaDisplayMode;_captchaProvider;_captchaSiteKey;constructor(e,t){super(e,t),this._captchaDisplayMode=e.captchaDisplayMode,this._captchaProvider=e.captchaProvider,this._captchaSiteKey=e.captchaSiteKey}getDataNode(){}custom_setProperty(e){this.applyUpdates(e.payload)}get captchaDisplayMode(){return this._captchaDisplayMode}get captchaProvider(){return this._captchaProvider}get captchaSiteKey(){return this._captchaSiteKey}}class Ft extends wt{click(){if(!this._events?.click&&this._jsonModel.buttonType)return"submit"===this._jsonModel.buttonType?this.form.dispatch(new g({validate_form:!0})):"reset"===this._jsonModel.buttonType?this.form.dispatch(new y):void 0}}const kt={text:"text-input",number:"number-input",email:"email",file:"file-input",range:"range",textarea:"multiline-input"};const Pt=new class{createField(e,t){let n;const i={...t,fieldFactory:this};if(e.fieldType=e.fieldType?e.fieldType in kt?kt[e.fieldType]:e.fieldType:"text-input",J(e)){const t={...e,..."items"in e&&{type:"object"},minOccur:void 0,maxOccur:void 0,repeatable:void 0,name:void 0},s={minItems:e.minOccur||0,maxItems:e.maxOccur||-1,fieldType:e.fieldType,type:"array",name:e.name,dataRef:e.dataRef,events:{"custom:setProperty":"$event.payload"},items:[t]};n=new Et(s,i)}else"items"in e||"panel"===e.fieldType?n=new jt(e,i):W(e)||"file-input"===e.fieldType?n=new $t(e,i):(s=e,n="checkbox"===(s?.fieldType||B(s))?new Dt(e,i):function(e){return"checkbox-group"===(e?.fieldType||B(e))}(e)?new Nt(e,i):function(e){const t=e?.fieldType||B(e);return"text-input"===t&&"email"===e?.format||"email"===t}(e)?new Ct(e,i):function(e){const t=e?.fieldType||B(e);return"text-input"===t&&"date"===e?.format||"date-input"===t}(e)?new St(e,i):function(e){const t=e?.fieldType||B(e);return"text-input"===t&&"date-time"===e?.format||"datetime-input"===t}(e)?new Ot(e,i):function(e){return"captcha"===(e?.fieldType||B(e))}(e)?new At(e,i):function(e){return"button"===e?.fieldType}(e)?new Ft(e,i):new wt(e,i));var s;return n}},Rt=(e,t,n)=>{let i=n;null==i&&(e=Te(e),i=new vt({...e},Pt,new bt,new rt(new it(t)),t));const s=e?.data;return s&&i.importData(s),i},qt=(e,t,n="error",i=void 0)=>{try{const s=Rt(e,n,i);return"function"==typeof t&&t(s),s.getEventQueue().runPendingQueue(),s}catch(e){throw console.error(`Unable to create an instance of the Form ${e}`),new Error(e)}},Vt=async(e,t,n="error",i=void 0)=>{try{const s=Rt(e,n,i);return"function"==typeof t&&t(s),s.getEventQueue().runPendingQueue(),await s.waitForPromises(),s}catch(e){throw console.error(`Unable to create an instance of the Form ${e}`),new Error(e)}};qt.currentVersion=_t;const Lt={logLevel:"error"},Ut=(e,t=null,{logLevel:n}=Lt)=>{try{const i=new vt({...e},Pt,new bt,new rt(new it(n)),n,"restore");return t&&(i.bindToDataModel(new te("$form",t)),i.syncDataAndFormModel(i.getDataNode())),i.getEventQueue().empty(),i}catch(e){throw console.error(`Unable to restore an instance of the Form ${e}`),new Error(e)}},zt=(e,t)=>{try{const n=new vt({...e},Pt,new bt);return t&&n.importData(t),0===n.validate().length}catch(e){throw new Error(e)}},Ht=(e,t)=>{try{const n=new vt({...e},Pt,new bt);t&&n.importData(t);const i=n.validate();return{messages:i,valid:0===i.length}}catch(e){throw new Error(e)}},Qt=(e,t={})=>{const n=new Headers;return Object.entries(t).forEach((([e,t])=>{n.append(e,t)})),new Promise(((n,i)=>{at(`${e}.model.json`,null,{headers:t}).then((e=>{if(200!==e.status)i("Not Found");else{let t=e.body;if("model"in t){const{model:e}=t;t=e}n(X(t))}})).catch((e=>{i(`Network error: ${e.message||e}`)}))}))},Bt=e=>{ft.registerFunctions(e)};export{qt as createFormInstance,Vt as createFormInstanceSync,Qt as fetchForm,Bt as registerFunctions,Ut as restoreFormInstance,Ht as validateFormData,zt as validateFormInstance};
